あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】に基づいて、対象システムの「非同期連携方針(Outbox/Saga)」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。

---

**【形式】**\
`第〇章：##`\
`〇.〇：###`\
`小見出し：####`\
その他：通常テキスト\
表はMarkdown表形式で記載\
JSON / CSV形式は禁止

---

## 第1章：目的・適用範囲

### 1.1 目的

本書は、本システムにおける DDD/マイクロサービス前提の非同期連携方式（Outbox パターンおよび Saga パターン） の共通方針を定めることを目的とする。\
本書で定める要求は、BC 間連携および外部システム連携の設計・実装・運用において拘束力を持つものとする。

### 1.2 適用範囲

本書は、以下の対象に適用されなければならない。

* BC 間の非同期連携（ドメインイベント、統合イベント）
* 外部システムとの非同期連携（メッセージング／イベント駆動）
* Outbox テーブル／キュー／トピックを利用したメッセージ配信
* Saga による分散トランザクション制御（補償トランザクションを含む）

同期 API の設計方針は、API ガバナンス方針書 および トランザクション方針書 を参照しなければならない。

---

## 第2章 入力情報と前提

### 2.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 2.2 前提条件

* 非同期連携は、DDD/マイクロサービス前提のアーキテクチャ上で運用される：未確定
* Outbox／Saga 適用の最終判断は、トランザクション方針書およびコンテキストマップと整合して行う：未確定
* メッセージブローカー種別や具体的な QoS 設定値は別途インフラ設計で定義される：未確定
* 監視・運用・キャパシティ計画の具体値は、性能定義書・運用要件定義書で確定する：未確定
* 保管期間・監査要件・改ざん防止方式などの具体値は、ロギング／監査方針書およびセキュリティ方針を参照して決定する：未確定

---

## 第3章：非同期連携全体方針

### 3.1 同期/非同期の選択方針

BC 間または外部システムとの連携は、以下の基準に従い 非同期連携を採用しなければならない／採用してはならない条件 を明示しなければならない。\
トランザクション方針書で定義された「即時整合性」と「最終的整合性」の使い分け基準を、本書の非同期連携方式の選択基準と整合させなければならない。

### 3.1 方針定義表
| 連携種別 | 非同期採用の必須条件（例：可用性優先 等） | 非同期を避ける条件（例：強整合性必須 等） | 備考（参照ドキュメント） |
|------|-----------------------|-----------------------|--------------|
| BC 間連携 |  |  | トランザクション方針書を参照 |
| 外部システム連携 |  |  | 外部連携方針と整合 |

### 3.2 Outbox / Saga の適用方針

非同期連携を採用する場合、Outbox パターン・Saga パターン・単純イベント通知のいずれを採用するかについて、評価観点（データ整合性、可用性、実装コスト等） を定義しなければならない。\
各パターンの適用可否は、後述の「第9章 適用マトリクス」で BC/外部システムごとに明示しなければならない。

---

## 第4章：Outbox パターン方針

### 4.1 Outbox テーブル/ストアの構造・管理方針

Outbox テーブル（または同等のストア）は、各 BC ごとに論理的に分離されなければならない。\
Outbox レコードには、少なくとも以下の情報を保持しなければならない。\
Outbox の保管期間・アーカイブ/削除ポリシーは、本書で 範囲を規定 し、具体値は非機能要件定義書およびロギング／監査方針書にて確定しなければならない。

#### 4.1 Outbox 項目
| 項目名（例） | 説明 | 必須/任意 | 備考 |
|--------|----|-------|----|
| id | レコード識別子 | 必須 |  |
| aggregate_id | 対象集約の識別子 | 必須 | 集約仕様書参照 |
| event_type | イベント種別 | 必須 | ユビキタス言語 |
| payload | イベントペイロード | 必須 |  |
| status | 配信状態（未送信/送信済 等） | 必須 |  |
| retry_count | リトライ回数 | 任意 |  |
| last_error_code | 直近エラーコード | 任意 |  |
| created_at / updated_at | 作成/更新日時 | 必須 | 監査用途 |

### 4.2 Outbox 書き込み・配信プロセス方針

ドメイントランザクションと Outbox への書き込みは、同一トランザクションでコミットされなければならない（実現方式はトランザクション方針書を参照）。\
Outbox からメッセージブローカー等への配信は、専用の配信プロセス（バッチ/デーモン等）によって行われなければならない。\
配信プロセスは、冪等に設計されなければならない。

#### 4.2 プロセス要求一覧
| 番号 | 区分 | 要求内容（Must/ Shall） | 詳細設計の参照先 |
|----|----|-------------------|----------|
| O-01 | 書き込み | ドメイン更新と Outbox 書き込みは同一トランザクションとしなければならない。 | トランザクション方針書 |
| O-02 | 配信 | Outbox 配信プロセスは、最低1回以上の配信保証を満たさなければならない。 | 非機能要件定義書（信頼性） |
| O-03 | 冪等 | 再配信時に重複処理を防ぐため、メッセージには冪等性キーを付与しなければならない。 | 外部連携仕様書（ヘッダ定義） |

---

## 第5章：Saga 方針

### 5.1 オーケストレーション／コレオグラフィ方式

Saga 実現方式として、オーケストレーション方式、コレオグラフィ方式、またはその組み合わせを採用する場合の基準を定義しなければならない（詳細基準は未確定）。\
Saga の開始・終了・中断条件は、イベントストーミング図に基づき定義されなければならない。

#### 5.1 方式選択基準
| 観点 | オーケストレーション推奨条件（例） | コレオグラフィ推奨条件（例） | 備考（未確定項目） |
|----|-------------------|----------------|-----------|
| 複雑度 |  |  |  |
| 可観測性 |  |  |  |
| 変更頻度 |  |  |  |
| 関与 BC の数 |  |  |  |

### 5.2 Saga 状態管理・補償トランザクション

Saga の状態（進行中、完了、補償中、失敗等）は、トレーサビリティ確保のため永続化されなければならない。\
Saga に参加する各ステップには、可能な限り補償トランザクションを定義しなければならない（定義不可の場合は理由を記録すること）。\
Saga 状態・履歴の保管期間は、監査要件に従い設定しなければならない（期間は未確定：ロギング／監査方針書を参照）。

#### 5.2 Saga 状態項目
| 項目名（例） | 説明 | 備考 |
|--------|----|----|
| saga_id | Saga の識別子 |  |
| saga_type | Saga の種別 | 例：カード発行、限度変更等 |
| status | 状態（進行中/完了/補償中 等） |  |
| steps | ステップ一覧 | 詳細は設計で定義 |
| started_at | 開始日時 | 監査用途 |
| completed_at | 完了日時 |  |
| last_error | 直近エラー情報 |  |

---

## 第6章：整合性・エラーハンドリング・リトライ方針

### 6.1 整合性レベル

Outbox/Saga を利用する非同期連携は、トランザクション方針書で定義される「最終的整合性」レベルと整合した整合性要件を満たさなければならない。\
どの操作が強整合性を要求し、どの操作が最終的整合性で許容されるかを、ユースケース単位で整理しなければならない。

#### 6.1 ユースケース別整合性
| ユースケース名 | 連携対象BC/外部 | 要求整合性レベル（強/最終） | Saga/Outbox 利用有無 | 備考 |
|---------|-----------|----------------|------------------|----|
|  |  |  |  |  |
|  |  |  |  |  |
|  |  |  |  |  |

### 6.2 エラー分類・リトライ・タイムアウト

エラーの大分類（永続的エラー／一時的エラー／ビジネスエラー）を定義し、例外処理ポリシーと整合させなければならない。\
一時的エラーに対しては、自動リトライを行うルール（最大回数、間隔、バックオフ方式）を定義しなければならない（具体値は未確定：非機能要件定義書を参照）。\
タイムアウト発生時の挙動（Saga 中断、補償実行、オペレータ通知等）を定義しなければならない。

#### 6.2 エラー/リトライ方針
| 区分 | 方針概要（Must/ Shall） |
|----|-------------------|
| 永続的エラー | 例外処理ポリシーに準拠して人手対応/補償を定義すること。 |
| 一時的エラー | 自動リトライ回数・間隔を定義しなければならない。 |
| ビジネスエラー | ドメインルールに従って例外イベントを発行しなければならない。 |

---

## 第7章：セキュリティ・アクセス制御・監査

### 7.1 Outbox/Saga に対するアクセス制御

Outbox テーブルおよび Saga 状態ストアへのアクセスは、アプリケーション層の技術的ユーザに限定しなければならない（DB 直接操作の可否は未確定）。\
管理用途の参照・更新権限は、運用要件定義書で定義される運用ロールと整合させなければならない。

#### 7.1 アクセス制御マトリクス
| リソース | ロール（例） | 操作（参照/登録/更新/削除） | 許可/禁止 | 備考 |
|------|--------|-----------------|-------|----|
| Outbox テーブル | アプリケーション | 参照/登録/更新 |  |  |
| Outbox テーブル | 運用管理者 | 参照 |  |  |
| Saga 状態ストア | アプリケーション | 参照/登録/更新 |  |  |
| Saga 状態ストア | 監査担当 | 参照 |  |  |

### 7.2 保管期間・改ざん防止・監査証跡

Outbox レコードおよび Saga 状態・履歴の保管期間は、監査要件・法令要件を満たすよう設定しなければならない（年数等の具体値は未確定：ロギング／監査方針書を参照）。\
Outbox レコード削除・Saga 状態廃棄の操作は、監査証跡が残る形で実行されなければならない。\
メッセージ内容および状態変更履歴の改ざん防止措置（例：WORM ストレージ、署名等）を検討し、必要に応じて採用しなければならない（具体方式は未確定）。

#### 7.2 保管・監査ポリシー
| 対象データ | 保管期間（未確定） | 監査証跡の要否 | 改ざん防止要求 |
|-------|-----------|---------|---------|
| Outbox レコード |  | 必須 |  |
| Saga 状態 |  | 必須 |  |
| Saga 履歴（ログ） |  | 必須 |  |

---

## 第8章：運用・監視・キャパシティ方針

### 8.1 監視・アラート

Outbox の滞留件数、Saga の未完了件数、エラー件数等について、閾値を定義し監視しなければならない（閾値は未確定：性能定義書・運用要件定義書を参照）。\
重大な連携障害（一定時間以上の配信停止等）が発生した場合に、運用チームへアラートを通知しなければならない。

#### 8.1 監視項目
| 監視項目 | 閾値例（未確定） | アラートレベル | 備考 |
|------|----------|---------|----|
| Outbox 未送信件数 |  |  |  |
| Outbox 配信エラー件数 |  |  |  |
| Saga 未完了件数 |  |  |  |
| Saga 補償実行件数 |  |  |  |

### 8.2 キャパシティ・スケーリング

メッセージ量・Saga 数の将来予測に基づき、メッセージブローカーおよび Outbox テーブルの容量・スループット要件を定義しなければならない（具体値は未確定：性能定義書を参照）。\
スケーリング戦略（水平/垂直、シャーディング等）は、構成・運用方針書と整合させなければならない。

#### 8.2 キャパシティ計画
| 項目 | 想定値 | 計測方法 | 備考 |
|----|-----|------|----|
| 1日あたりイベント件数 |  |  |  |
| ピーク TPS |  |  |  |
| Outbox テーブル容量 |  |  |  |

---

## 第9章：BC／外部システム別適用マトリクス

### 9.1 適用方式マトリクス

各 BC および外部システムごとに、採用する非同期連携方式（Outbox／Saga／単純イベント通知／非採用）を一覧化しなければならない。\
本マトリクスは、コンテキストマップおよびアプリケーション分割書と整合していなければならない。
| 発信側 BC/システム | 受信側 BC/外部 | 連携内容概要 | 方式種別（Outbox/Saga/その他） | Saga 有無 | 備考 |
|-------------|-----------|--------|-----------------------|---------|----|
|  |  |  |  |  |  |
|  |  |  |  |  |  |
|  |  |  |  |  |  |