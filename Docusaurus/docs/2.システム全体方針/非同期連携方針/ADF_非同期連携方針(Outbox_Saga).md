あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】および【ISO/IEC Directives Part 2準拠ルール】に基づいて、対象システムの「非同期連携方針(Outbox/Saga)」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。

---

### 【形式】

章：`## 第1章 タイトル`\
節：`### 1.1 タイトル`\
項：`#### 1.1.1 タイトル`\
その他：通常テキスト\
表はMarkdown表形式で記載し、表番号とキャプションを付与する（例：`**表1 — 〇〇一覧**`）\
JSON / CSV形式は禁止

---

### 【ISO/IEC Directives Part 2準拠ルール】

#### 要求事項の表現
出力文書では以下の表現を使い分けること：

| 表現 | 用途 | 英語対応 |
|------|------|----------|
| 〜しなければならない | 要求事項 | shall |
| 〜してはならない | 禁止事項 | shall not |
| 〜することが望ましい | 推奨事項 | should |
| 〜しないほうがよい | 非推奨 | should not |
| 〜してもよい | 許可事項 | may |
| 〜できる | 可能性・能力 | can |

#### 文書構成の原則
- 要求事項と説明・解説を明確に区別すること
- 各章・節には目的を明示すること
- 表には連番とキャプションを付与すること

---

## 第1章 適用範囲

### 1.1 目的

本書は、本システムにおける DDD/マイクロサービス前提の非同期連携方式（Outbox パターンおよび Saga パターン） の共通方針を定めることを目的とする。\
本書で定める要求は、BC 間連携および外部システム連携の設計・実装・運用において拘束力を持つものとする。

### 1.2 適用範囲

本書は、以下の対象に適用しなければならない。

* BC 間の非同期連携（ドメインイベント、統合イベント）
* 外部システムとの非同期連携（メッセージング／イベント駆動）
* Outbox テーブル／キュー／トピックを利用したメッセージ配信
* Saga による分散トランザクション制御（補償トランザクションを含む）

同期 API の設計方針は、API ガバナンス方針書 および トランザクション方針書 を参照しなければならない。

**表1 — 適用範囲**
| 項目 | 記述内容 |
|----|------|
| 対象システム | ハウスクレジット基幹システム |
| 対象BC | ドメインスコープ定義書およびコンテキストマップに定義された全BC |
| 対象連携 | BC間非同期連携、外部システム非同期連携 |
| 除外対象 | 同期API（APIガバナンス方針書を参照） |

### 1.3 関連文書

**表2 — 関連文書一覧**
| 関連ドキュメント | 関係性 |
|----------------|--------|
| トランザクション方針書 | トランザクション境界・整合性方針を参照 |
| APIガバナンス方針書 | 同期API・Event APIの設計方針を参照 |
| ロギング／監査方針書 | 監査要件・保管期間を参照 |
| セキュリティ方針書 | アクセス制御・改ざん防止を参照 |

---

## 第2章 引用規格

本書は以下の規格・標準を参照する：

- Microservices Patterns (Chris Richardson)
- Enterprise Integration Patterns (Gregor Hohpe)

---

## 第3章 用語及び定義

**表3 — 用語定義**
| 用語 | 定義 |
|------|------|
| Outboxパターン | ドメイン更新とメッセージ発行を同一トランザクションで行い、配信を別プロセスで実行するパターン |
| Sagaパターン | 分散トランザクションを一連のローカルトランザクションと補償トランザクションで実現するパターン |
| オーケストレーション | 中央のコーディネーターがSagaの進行を制御する方式 |
| コレオグラフィ | 各サービスがイベントに反応して連携する方式 |
| 補償トランザクション | Saga失敗時に実行される取り消し処理 |
| DLQ | Dead Letter Queue。処理失敗メッセージの退避先 |

---

## 第4章 入力情報と前提

### 4.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 4.2 前提条件

* 非同期連携は、DDD/マイクロサービス前提のアーキテクチャ上で運用される：未確定
* Outbox／Saga 適用の最終判断は、トランザクション方針書およびコンテキストマップと整合して行う：未確定
* メッセージブローカー種別や具体的な QoS 設定値は別途インフラ設計で定義される：未確定
* 監視・運用・キャパシティ計画の具体値は、性能定義書・運用要件定義書で確定する：未確定
* 保管期間・監査要件・改ざん防止方式などの具体値は、ロギング／監査方針書およびセキュリティ方針を参照して決定する：未確定

---

## 第5章 非同期連携全体方針

### 5.1 同期/非同期の選択方針

BC 間または外部システムとの連携は、以下の基準に従い非同期連携を採用しなければならない。

**表4 — 同期/非同期選択基準**
| 連携種別 | 非同期採用条件 | 非同期回避条件 | 参照先 |
|------|-----------------------|-----------------------|--------------|
| BC間連携 | 可用性優先、疎結合が必要 | 強整合性必須、即時応答必須 | トランザクション方針書 |
| 外部システム連携 | 応答遅延許容、信頼性確保 | リアルタイム応答必須 | 外部連携方針 |

### 5.2 Outbox / Saga の適用方針

**表5 — パターン選択基準**
| パターン | 適用条件 | 評価観点 |
|---------|---------|----------|
| Outboxパターン | 単一BC内の整合性＋外部への通知 | データ整合性、実装コスト |
| Sagaパターン | BC横断の業務フロー | 複雑性、補償トランザクション設計 |
| 単純イベント通知 | 通知のみ、結果整合性許容 | 可用性、実装コスト |

---

## 第6章 Outbox パターン方針

### 6.1 Outbox テーブル構造

Outbox テーブルは、各 BC ごとに論理的に分離しなければならない。

**表6 — Outbox 必須項目**
| 項目名 | 説明 | 必須/任意 |
|--------|----|-------|
| id | レコード識別子 | 必須 |
| aggregate_id | 対象集約の識別子 | 必須 |
| event_type | イベント種別 | 必須 |
| payload | イベントペイロード | 必須 |
| status | 配信状態（未送信/送信済 等） | 必須 |
| retry_count | リトライ回数 | 任意 |
| last_error_code | 直近エラーコード | 任意 |
| created_at / updated_at | 作成/更新日時 | 必須 |

### 6.2 Outbox 書き込み・配信プロセス方針

**表7 — Outbox プロセス要求**
| 番号 | 要求内容 |
|----|-------------------|
| O-01 | ドメイン更新と Outbox 書き込みは同一トランザクションとしなければならない |
| O-02 | Outbox 配信プロセスは、最低1回以上の配信保証を満たさなければならない |
| O-03 | 再配信時に重複処理を防ぐため、メッセージには冪等性キーを付与しなければならない |

---

## 第7章 Saga 方針

### 7.1 オーケストレーション／コレオグラフィ方式

**表8 — Saga方式選択基準**
| 観点 | オーケストレーション推奨 | コレオグラフィ推奨 |
|----|-------------------|----------------|
| 複雑度 | フロー複雑、状態管理必要 | フロー単純、疎結合 |
| 可観測性 | 一元的な状態把握が必要 | 分散モニタリング可 |
| 変更頻度 | フロー変更が多い | イベント追加が多い |
| 関与BC数 | 3以上 | 2程度 |

### 7.2 Saga 状態管理・補償トランザクション

**表9 — Saga 状態項目**
| 項目名 | 説明 |
|--------|-----|
| saga_id | Saga の識別子 |
| saga_type | Saga の種別 |
| status | 状態（進行中/完了/補償中 等） |
| steps | ステップ一覧 |
| started_at | 開始日時 |
| completed_at | 完了日時 |
| last_error | 直近エラー情報 |

**表10 — Saga 状態管理要求**
| 要求 | 説明 |
|------|------|
| 永続化 | Saga の状態はトレーサビリティ確保のため永続化しなければならない |
| 補償定義 | 各ステップには可能な限り補償トランザクションを定義しなければならない |
| 監査保管 | Saga 状態・履歴の保管期間は監査要件に従わなければならない |

---

## 第8章 整合性・エラーハンドリング・リトライ方針

### 8.1 整合性レベル

**表11 — 整合性要求**
| 要求 | 説明 |
|------|------|
| 最終的整合性 | Outbox/Sagaを利用する非同期連携は最終的整合性を前提としなければならない |
| 強整合性要件 | 強整合性が必要な操作は同期処理としなければならない |

### 8.2 エラー分類・リトライ・タイムアウト

**表12 — エラー/リトライ方針**
| 区分 | 方針 |
|----|----|
| 永続的エラー | 人手対応/補償を定義しなければならない |
| 一時的エラー | 自動リトライを実施しなければならない（最大3回、Exponential Backoff） |
| ビジネスエラー | ドメインルールに従って例外イベントを発行しなければならない |
| タイムアウト | Saga中断、補償実行、オペレータ通知を行わなければならない |

---

## 第9章 セキュリティ・アクセス制御・監査

### 9.1 アクセス制御

**表13 — アクセス制御方針**
| リソース | ロール | 操作 |
|------|--------|-----------------|
| Outbox テーブル | アプリケーション | 参照/登録/更新 |
| Outbox テーブル | 運用管理者 | 参照のみ |
| Saga 状態ストア | アプリケーション | 参照/登録/更新 |
| Saga 状態ストア | 監査担当 | 参照のみ |

### 9.2 保管期間・改ざん防止

**表14 — 保管・監査方針**
| 対象データ | 監査証跡 | 改ざん防止 |
|-------|---------|---------|
| Outbox レコード | 必須 | WORM/署名を検討 |
| Saga 状態 | 必須 | WORM/署名を検討 |
| Saga 履歴（ログ） | 必須 | WORM/署名を検討 |

---

## 第10章 運用・監視・キャパシティ方針

### 10.1 監視・アラート

**表15 — 監視項目**
| 監視項目 | アラートレベル |
|------|---------|
| Outbox 未送信件数 | 閾値超過でWarning |
| Outbox 配信エラー件数 | 閾値超過でCritical |
| Saga 未完了件数 | 閾値超過でWarning |
| Saga 補償実行件数 | 発生時にInfo |

### 10.2 キャパシティ・スケーリング

**表16 — キャパシティ計画**
| 項目 | 方針 |
|----|-----|
| イベント件数予測 | 性能定義書に基づき設計しなければならない |
| スケーリング戦略 | 構成・運用方針書と整合しなければならない |

---

## 第11章 BC／外部システム別適用マトリクス

**表17 — 適用方式マトリクス（テンプレート）**
| 発信側 BC/システム | 受信側 BC/外部 | 連携内容 | 方式種別 | Saga有無 |
|-------------|-----------|--------|------|----|
| （設計時に記入） | | | | |