---
id: AIPZZZZ001
title: 非同期連携方針(Outbox/Saga)
sidebar_position: 1
---

# 非同期連携方針(Outbox/Saga)

| 項目 | 内容 |
|------|------|
| ドキュメントID | AIPZZZZ001 |
| 版数 | 1.0 |
| 作成日 | 2026-01-15 |
| 最終更新日 | 2026-01-15 |
| ステータス | ドラフト |

---

## 第1章 適用範囲

### 1.1 目的

本書は、ハウスクレジット基幹システムにおけるDDD/マイクロサービス前提の非同期連携方式（OutboxパターンおよびSagaパターン）の共通方針を定めることを目的とする。

本書で定める要求は、BC間連携および外部システム連携の設計・実装・運用において拘束力を持つものとする。

### 1.2 適用範囲

本書は、以下の対象に適用しなければならない。

**表1 — 適用範囲**

| 項目 | 記述内容 |
|------|----------|
| 対象システム | ハウスクレジット基幹システム |
| 対象BC | ドメインスコープ定義書およびコンテキストマップに定義された全BC |
| 対象連携 | BC間非同期連携、外部システム非同期連携 |
| 除外対象 | 同期API（APIガバナンス方針書を参照） |

**適用対象の詳細：**

- BC間の非同期連携（ドメインイベント、統合イベント）
- 外部システムとの非同期連携（メッセージング／イベント駆動）
- Outboxテーブル／キュー／トピックを利用したメッセージ配信
- Sagaによる分散トランザクション制御（補償トランザクションを含む）

同期APIの設計方針は、APIガバナンス方針書およびトランザクション方針書を参照しなければならない。

### 1.3 関連文書

**表2 — 関連文書一覧**

| 関連ドキュメント | 関係性 |
|------------------|--------|
| トランザクション方針書 | トランザクション境界・整合性方針を参照 |
| APIガバナンス方針書 | 同期API・Event APIの設計方針を参照 |
| アプリケーションログ方針書 | 監査要件・保管期間を参照 |
| セキュリティ方針書 | アクセス制御・改ざん防止を参照 |
| 例外処理ポリシー | エラーハンドリング・リトライ方針を参照 |

---

## 第2章 引用規格

本書は以下の規格・標準を参照する：

- Microservices Patterns (Chris Richardson)
- Enterprise Integration Patterns (Gregor Hohpe)
- Domain-Driven Design (Eric Evans)

---

## 第3章 用語及び定義

本書で使用する主要な用語を以下に定義する。

**表3 — 用語定義**

| 用語 | 定義 |
|------|------|
| Outboxパターン | ドメイン更新とメッセージ発行を同一トランザクションで行い、配信を別プロセスで実行するパターン |
| Sagaパターン | 分散トランザクションを一連のローカルトランザクションと補償トランザクションで実現するパターン |
| オーケストレーション | 中央のコーディネーターがSagaの進行を制御する方式 |
| コレオグラフィ | 各サービスがイベントに反応して連携する方式 |
| 補償トランザクション | Saga失敗時に実行される取り消し処理 |
| DLQ | Dead Letter Queue。処理失敗メッセージの退避先 |
| 冪等性 | 同じ操作を複数回実行しても結果が変わらない性質 |
| 最終的整合性 | 一定時間後にシステム全体で整合性が保たれる状態 |

---

## 第4章 非同期連携全体方針

### 4.1 同期/非同期の選択方針

BC間または外部システムとの連携は、以下の基準に従い非同期連携を採用しなければならない。

**表4 — 同期/非同期選択基準**

| 連携種別 | 非同期採用条件 | 非同期回避条件 | 参照先 |
|----------|---------------|---------------|---------|
| BC間連携 | 可用性優先、疎結合が必要、結果整合性許容 | 強整合性必須、即時応答必須 | トランザクション方針書 |
| 外部システム連携 | 応答遅延許容、信頼性確保、リトライ必要 | リアルタイム応答必須 | 外部連携方針 |

### 4.2 Outbox / Saga の適用方針

**表5 — パターン選択基準**

| パターン | 適用条件 | 評価観点 | 例 |
|---------|---------|---------|-----|
| Outboxパターン | 単一BC内の整合性＋外部への通知 | データ整合性、実装コスト | 売上確定後のポイント付与通知 |
| Sagaパターン | BC横断の業務フロー、補償が必要 | 複雑性、補償トランザクション設計 | 申込→審査→発行の一連のフロー |
| 単純イベント通知 | 通知のみ、結果整合性許容 | 可用性、実装コスト | 統計情報の更新 |

### 4.3 非同期連携の基本原則

**表6 — 非同期連携基本原則**

| 原則 | 説明 |
|------|------|
| 最終的整合性 | BC間連携は最終的整合性を前提としなければならない |
| 冪等性保証 | メッセージ処理は冪等でなければならない |
| At-least-once配信 | メッセージは最低1回配信を保証しなければならない |
| イベントの順序性 | 同一集約に関するイベントの順序性を保証することが望ましい |
| BC自律性 | 各BCは他BCのダウンタイムに影響されずに動作できなければならない |

---

## 第5章 Outboxパターン方針

### 5.1 Outboxテーブル構造

Outboxテーブルは、各BCごとに論理的に分離しなければならない。

**表7 — Outbox必須項目**

| 項目名 | データ型 | 説明 | 必須/任意 |
|--------|---------|------|----------|
| id | UUID/BIGINT | レコード識別子（主キー） | 必須 |
| aggregate_id | VARCHAR | 対象集約の識別子 | 必須 |
| aggregate_type | VARCHAR | 集約の種別 | 必須 |
| event_type | VARCHAR | イベント種別 | 必須 |
| payload | JSON/TEXT | イベントペイロード（JSON形式） | 必須 |
| status | ENUM | 配信状態（PENDING/SENT/FAILED） | 必須 |
| retry_count | INT | リトライ回数 | 任意 |
| last_error_code | VARCHAR | 直近エラーコード | 任意 |
| last_error_message | TEXT | 直近エラーメッセージ | 任意 |
| created_at | TIMESTAMP | 作成日時 | 必須 |
| updated_at | TIMESTAMP | 更新日時 | 必須 |
| sent_at | TIMESTAMP | 送信完了日時 | 任意 |

### 5.2 Outbox書き込み・配信プロセス方針

**表8 — Outboxプロセス要求**

| 番号 | 要求内容 |
|------|----------|
| O-01 | ドメイン更新とOutbox書き込みは同一トランザクションとしなければならない |
| O-02 | Outbox配信プロセスは、最低1回以上の配信保証を満たさなければならない |
| O-03 | 再配信時に重複処理を防ぐため、メッセージには冪等性キー（イベントID）を付与しなければならない |
| O-04 | Outbox配信プロセスは定期的（例：1秒間隔）に未送信レコードをポーリングしなければならない |
| O-05 | 配信失敗時はリトライを実施し、リトライ上限を超えた場合はDLQに退避しなければならない |

### 5.3 Outboxポーリングと配信

**表9 — Outboxポーリング方針**

| 項目 | 方針 |
|------|------|
| ポーリング間隔 | 1秒間隔を基本とする（負荷に応じて調整可） |
| バッチサイズ | 1回のポーリングで取得する件数は100件を上限とする |
| 並列処理 | 複数のワーカーで並列配信することが望ましい |
| ロック制御 | 同一レコードの重複配信を防ぐため、楽観ロックを使用しなければならない |

### 5.4 Outboxクリーンアップ

**表10 — Outboxクリーンアップ方針**

| 項目 | 方針 |
|------|------|
| 保管期間 | 送信済みレコードは7日間保管後、削除またはアーカイブしなければならない |
| アーカイブ | 監査要件がある場合は、削除前にアーカイブストレージに移動しなければならない |
| 失敗レコード | DLQに退避された失敗レコードは手動確認・対応後に削除しなければならない |

---

## 第6章 Sagaパターン方針

### 6.1 オーケストレーション／コレオグラフィ方式

Sagaの実装方式は、以下の基準に従って選択しなければならない。

**表11 — Saga方式選択基準**

| 観点 | オーケストレーション推奨 | コレオグラフィ推奨 |
|------|----------------------|------------------|
| 複雑度 | フロー複雑、状態管理必要 | フロー単純、疎結合 |
| 可観測性 | 一元的な状態把握が必要 | 分散モニタリング可 |
| 変更頻度 | フロー変更が多い | イベント追加が多い |
| 関与BC数 | 3以上 | 2程度 |
| 補償制御 | 複雑な補償フロー | シンプルな補償 |

### 6.2 Saga状態管理

#### 6.2.1 Saga状態テーブル構造

**表12 — Saga状態項目**

| 項目名 | データ型 | 説明 | 必須/任意 |
|--------|---------|------|----------|
| saga_id | UUID | Sagaの識別子（主キー） | 必須 |
| saga_type | VARCHAR | Sagaの種別 | 必須 |
| status | ENUM | 状態（STARTED/RUNNING/COMPLETED/COMPENSATING/FAILED） | 必須 |
| current_step | INT | 現在のステップ番号 | 必須 |
| steps | JSON | ステップ一覧と各ステップの状態 | 必須 |
| payload | JSON | Saga実行に必要なデータ | 必須 |
| started_at | TIMESTAMP | 開始日時 | 必須 |
| completed_at | TIMESTAMP | 完了日時 | 任意 |
| last_error | TEXT | 直近エラー情報 | 任意 |
| created_at | TIMESTAMP | 作成日時 | 必須 |
| updated_at | TIMESTAMP | 更新日時 | 必須 |

#### 6.2.2 Saga状態管理要求

**表13 — Saga状態管理要求**

| 要求 | 説明 |
|------|------|
| 永続化 | Sagaの状態はトレーサビリティ確保のため永続化しなければならない |
| 補償定義 | 各ステップには可能な限り補償トランザクションを定義しなければならない |
| 監査保管 | Saga状態・履歴の保管期間は監査要件に従わなければならない |
| タイムアウト | Saga全体のタイムアウトを設定しなければならない（具体値は未確定） |
| リトライ制御 | 各ステップのリトライ回数・間隔を定義しなければならない |

### 6.3 補償トランザクション設計

**表14 — 補償トランザクション設計原則**

| 原則 | 説明 |
|------|------|
| 冪等性 | 補償トランザクションは冪等でなければならない |
| セマンティック補償 | 業務的に意味のある補償（例：予約キャンセル）を実装しなければならない |
| ピボットトランザクション | 補償不可能なステップ（ピボットトランザクション）以降は補償を実施しないこと |
| 完全復旧不可 | 完全な復旧が不可能な場合は、管理者介入フローを定義しなければならない |
| ログ記録 | すべての補償実行は詳細にログ記録しなければならない |

### 6.4 Saga実装パターン

#### 6.4.1 オーケストレーション実装

**表15 — オーケストレーション実装要件**

| 要件 | 説明 |
|------|------|
| オーケストレータ | 中央のオーケストレータコンポーネントを実装しなければならない |
| ステップ定義 | 各ステップの実行順序・補償順序を明確に定義しなければならない |
| 状態遷移 | 状態遷移図を作成し、すべての状態とイベントを定義しなければならない |
| エラーハンドリング | 各ステップのエラーハンドリング戦略を定義しなければならない |

#### 6.4.2 コレオグラフィ実装

**表16 — コレオグラフィ実装要件**

| 要件 | 説明 |
|------|------|
| イベント定義 | BC間で交換されるすべてのイベントを明確に定義しなければならない |
| イベントフロー | イベントフロー図を作成し、全体像を可視化しなければならない |
| 補償イベント | 各BCは補償イベントを受信して適切に処理しなければならない |
| デッドロック回避 | イベントループを避ける設計を行わなければならない |

---

## 第7章 整合性・エラーハンドリング・リトライ方針

### 7.1 整合性レベル

**表17 — 整合性要求**

| 要求 | 説明 |
|------|------|
| 最終的整合性 | Outbox/Sagaを利用する非同期連携は最終的整合性を前提としなければならない |
| 強整合性要件 | 強整合性が必要な操作は同期処理としなければならない |
| 整合性期間 | 最終的整合性が達成されるまでの目標時間を定義しなければならない（例：5秒以内） |

### 7.2 エラー分類とハンドリング

**表18 — エラー分類・ハンドリング方針**

| エラー区分 | 例 | 方針 |
|-----------|-----|------|
| 永続的エラー | ビジネスルール違反、データ不整合 | 人手対応/補償を定義し、DLQに退避しなければならない |
| 一時的エラー | ネットワーク障害、一時的なDB接続エラー | 自動リトライを実施しなければならない（最大3回、Exponential Backoff） |
| ビジネスエラー | 与信枠不足、在庫不足 | ドメインルールに従って例外イベントを発行しなければならない |
| タイムアウト | 処理時間超過 | Saga中断、補償実行、オペレータ通知を行わなければならない |

### 7.3 リトライ戦略

**表19 — リトライ方針**

| 項目 | 方針 |
|------|------|
| リトライ回数 | 最大3回を基本とする |
| バックオフ | Exponential Backoff（初回1秒、2回目2秒、3回目4秒）を採用しなければならない |
| リトライ対象 | 一時的エラーのみリトライ対象としなければならない |
| リトライ上限 | リトライ上限を超えた場合はDLQに退避しなければならない |
| 冪等性確保 | リトライ時の冪等性を保証しなければならない |

### 7.4 DLQ（Dead Letter Queue）管理

**表20 — DLQ管理方針**

| 項目 | 方針 |
|------|------|
| 退避条件 | リトライ上限超過、永続的エラー発生時にDLQに退避しなければならない |
| 監視 | DLQ滞留件数を監視し、閾値超過時にアラートを発報しなければならない |
| 対応フロー | DLQメッセージは定期的に確認し、原因調査・対応を実施しなければならない |
| 再処理 | 対応完了後、必要に応じて手動で再処理を実施しなければならない |
| 保管期間 | DLQメッセージは14日間保管後、アーカイブまたは削除しなければならない |

---

## 第8章 メッセージング基盤方針

### 8.1 メッセージブローカー選定

**表21 — メッセージブローカー選定基準**

| 要件 | 説明 |
|------|------|
| 信頼性 | At-least-once配信を保証できること |
| スケーラビリティ | 将来の負荷増加に対応できること |
| 可観測性 | メッセージ配信状況を監視できること |
| 順序性保証 | 必要に応じてメッセージ順序を保証できること |
| DLQサポート | DLQ機能をネイティブでサポートしていることが望ましい |

**注記：** 具体的な技術選定（Kafka、RabbitMQ、AWS SQS/SNS等）は別途検討する。

### 8.2 メッセージフォーマット

**表22 — メッセージフォーマット要件**

| 項目 | 要件 |
|------|------|
| 形式 | JSON形式を標準とする |
| イベントID | 一意なイベントIDを含めなければならない |
| タイムスタンプ | イベント発生日時を含めなければならない |
| バージョン | スキーマバージョンを含めることが望ましい |
| トレースID | 分散トレーシング用のトレースIDを含めることが望ましい |
| ペイロード | 必要最小限のデータのみを含めなければならない |

### 8.3 トピック/キュー設計

**表23 — トピック/キュー設計方針**

| 項目 | 方針 |
|------|------|
| 命名規則 | `{環境}.{BC名}.{イベント種別}` の形式で命名しなければならない |
| パーティショニング | 集約IDによるパーティショニングで順序性を保証することが望ましい |
| トピック分離 | BCごとにトピックを分離しなければならない |
| DLQトピック | 各トピックに対応するDLQトピックを作成しなければならない |

---

## 第9章 セキュリティ・アクセス制御・監査

### 9.1 アクセス制御

**表24 — アクセス制御方針**

| リソース | ロール | 操作 |
|---------|--------|------|
| Outboxテーブル | アプリケーション | 参照/登録/更新 |
| Outboxテーブル | 運用管理者 | 参照のみ |
| Saga状態ストア | アプリケーション | 参照/登録/更新 |
| Saga状態ストア | 監査担当 | 参照のみ |
| メッセージブローカー | アプリケーション | 発行/購読 |
| DLQトピック | 運用管理者 | 参照/再処理 |

### 9.2 メッセージ暗号化

**表25 — メッセージ暗号化方針**

| 項目 | 方針 |
|------|------|
| 転送時暗号化 | TLS 1.3以上を使用しなければならない |
| 保存時暗号化 | 機微情報を含むメッセージは保存時も暗号化することが望ましい |
| PIIマスキング | ログに出力するメッセージはPIIをマスキングしなければならない |

### 9.3 保管期間・改ざん防止

**表26 — 保管・監査方針**

| 対象データ | 監査証跡 | 改ざん防止 | 保管期間 |
|-----------|---------|-----------|---------|
| Outboxレコード | 必須 | WORM/署名を検討 | 送信済み7日、失敗14日 |
| Saga状態 | 必須 | WORM/署名を検討 | 完了後30日 |
| Saga履歴（ログ） | 必須 | WORM/署名を検討 | 監査要件に従う（例：7年） |
| メッセージログ | 必須 | 推奨 | 監査要件に従う |

---

## 第10章 運用・監視・キャパシティ方針

### 10.1 監視・アラート

**表27 — 監視項目**

| 監視項目 | メトリクス | アラートレベル | 閾値例 |
|---------|-----------|--------------|--------|
| Outbox未送信件数 | 件数 | Warning | 100件超過 |
| Outbox配信エラー率 | エラー率 | Critical | 5%超過 |
| Saga未完了件数 | 件数 | Warning | 10件超過 |
| Saga完了時間 | 時間 | Warning | 目標時間の2倍超過 |
| Saga補償実行件数 | 件数 | Info | 発生時に記録 |
| DLQ滞留件数 | 件数 | Warning | 10件超過 |
| メッセージレイテンシ | 時間 | Warning | 5秒超過 |

### 10.2 ダッシュボード

**表28 — ダッシュボード要件**

| ダッシュボード | 表示内容 |
|--------------|---------|
| Outbox監視 | 未送信件数、エラー率、配信スループット |
| Saga監視 | 実行中Saga数、完了率、平均完了時間、補償実行数 |
| DLQ監視 | 滞留件数、滞留時間、エラー種別分布 |
| 全体サマリ | システム全体の非同期連携状況、異常検知 |

### 10.3 キャパシティ・スケーリング

**表29 — キャパシティ計画**

| 項目 | 方針 |
|------|------|
| イベント件数予測 | 性能定義書に基づき設計しなければならない（具体値は未確定） |
| スケーリング戦略 | 構成・運用方針書と整合しなければならない |
| ピーク対応 | ピーク時の負荷を考慮したキャパシティを確保しなければならない |
| バッファリング | メッセージブローカーに適切なバッファを設定しなければならない |

---

## 第11章 テスト方針

### 11.1 テスト種別

**表30 — テスト種別と観点**

| テスト種別 | テスト観点 | 実施タイミング |
|-----------|-----------|---------------|
| 単体テスト | Outbox書き込み、イベント発行ロジック | 開発中 |
| 統合テスト | BC間イベント配信、Saga実行フロー | 結合テスト |
| エンドツーエンドテスト | 非同期連携を含む業務フロー全体 | システムテスト |
| 障害テスト | リトライ、補償トランザクション、DLQ退避 | システムテスト |
| 性能テスト | スループット、レイテンシ | 性能テスト |

### 11.2 テスト実施要件

**表31 — テスト実施要件**

| 要件 | 説明 |
|------|------|
| 冪等性テスト | 同一メッセージの重複配信をテストしなければならない |
| 順序性テスト | メッセージの順序性が保たれることをテストしなければならない |
| 補償テスト | 各Sagaステップの補償トランザクションをテストしなければならない |
| 障害復旧テスト | 障害発生後の自動復旧をテストしなければならない |
| タイムアウトテスト | タイムアウト発生時の動作をテストしなければならない |

---

## 第12章 BC/外部システム別適用方針

### 12.1 適用方式の決定

各BC間連携および外部システム連携について、以下のマトリクスに基づいて適用方式を決定しなければならない。

**表32 — 適用方式マトリクス（テンプレート）**

| 発信側BC/システム | 受信側BC/外部 | 連携内容 | 方式種別 | Saga有無 | 備考 |
|----------------|-------------|---------|---------|---------|------|
| （設計時に記入） | （設計時に記入） | （設計時に記入） | Outbox/Saga/同期 | 有/無 | （設計時に記入） |

**記入例：**

| 発信側BC/システム | 受信側BC/外部 | 連携内容 | 方式種別 | Saga有無 | 備考 |
|----------------|-------------|---------|---------|---------|------|
| 売上確定BC | ポイントBC | 売上確定通知 | Outbox | 無 | 単純な通知のみ |
| 審査BC | 発行BC | 審査完了→発行指示 | Saga | 有 | 申込フロー全体をSagaで管理 |
| 請求BC | 会計連携BC | 請求確定通知 | Outbox | 無 | 会計システムへの連携 |

---

## 付録A 未確定事項一覧

本方針書において「未確定」と記載された事項を以下にまとめる。これらは後続の検討・合意形成により確定させなければならない。

**表A.1 — 未確定事項一覧**

| 章節 | 項目 | 備考 |
|------|------|------|
| 6.2.2 | Saga全体のタイムアウト具体値 | 非機能要件との整合が必要 |
| 8.1 | メッセージブローカーの技術選定 | Kafka、RabbitMQ、AWS SQS/SNS等の評価・選定が必要 |
| 10.3 | イベント件数予測の具体値 | 性能定義書での定義が必要 |

---

## 付録B 検討が必要な論点

以下は、本方針書の運用にあたり検討が必要な論点である。

1. **メッセージブローカーの技術選定**
   - Kafka、RabbitMQ、AWS SQS/SNS、Azure Service Bus等の比較評価
   - オンプレミス vs クラウドマネージド
   - コスト、運用負荷、スケーラビリティの観点での評価
   - 既存システムとの統合

2. **Outbox配信プロセスの実装方式**
   - Change Data Capture (CDC)の採用可否
   - ポーリング vs CDC の比較
   - Debezium等のOSSツールの活用
   - カスタム実装 vs 既製ツール

3. **イベントスキーマ管理**
   - スキーマレジストリの導入（Apache Avro、JSON Schema等）
   - スキーマバージョニング戦略
   - 下位互換性の保証方法
   - スキーマ変更時の移行手順

4. **順序性保証の実装**
   - パーティショニング戦略の詳細
   - 集約IDによる順序保証の実装
   - 順序性とスケーラビリティのトレードオフ

5. **Saga実装フレームワークの選定**
   - Axon Framework、Eventuate Tram等の評価
   - カスタム実装 vs フレームワーク利用
   - 言語・フレームワークとの整合性

6. **モニタリング・オブザーバビリティ**
   - 分散トレーシングの実装（Jaeger、Zipkin等）
   - メトリクス収集・可視化ツール（Prometheus、Grafana等）
   - ログ集約（ELK Stack、Splunk等）
   - アラート設定の詳細

7. **災害復旧・事業継続性**
   - メッセージブローカーのバックアップ・復旧手順
   - Outbox/Saga状態の復旧手順
   - クロスリージョン構成の検討
   - RTO/RPOの定義

8. **パフォーマンスチューニング**
   - メッセージサイズの最適化
   - バッチ処理とリアルタイム処理のバランス
   - バックプレッシャー制御
   - スループット目標値の設定

9. **セキュリティ強化**
   - エンドツーエンド暗号化の実装
   - メッセージ署名・検証
   - アクセス制御の詳細設計
   - 監査ログの暗号化

10. **移行戦略**
    - 既存システムからの段階的移行
    - 同期連携から非同期連携への移行手順
    - ハイブリッド運用期間の管理
    - データ整合性の検証方法

---
