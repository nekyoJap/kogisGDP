あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】および【ISO/IEC Directives Part 2準拠ルール】に基づいて、対象システムの「データモデリング方針書」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。\
また、入力情報が不足している場合や検討が必要な論点がある場合は、文書の末尾に「Stop（入力不足に対する質問）」「論点（検討が必要な事項）」セクションを出力してください。

---

### 【形式】

章：`## 第1章 タイトル`\
節：`### 1.1 タイトル`\
項：`#### 1.1.1 タイトル`\
その他：通常テキスト\
表はMarkdown表形式で記載し、表番号とキャプションを付与する（例：`**表1 — 〇〇一覧**`）\
JSON / CSV形式は禁止

---

### 【ISO/IEC Directives Part 2準拠ルール】

#### 要求事項の表現
出力文書では以下の表現を使い分けること：

| 表現 | 用途 | 英語対応 |
|------|------|----------|
| 〜しなければならない | 要求事項 | shall |
| 〜してはならない | 禁止事項 | shall not |
| 〜することが望ましい | 推奨事項 | should |
| 〜しないほうがよい | 非推奨 | should not |
| 〜してもよい | 許可事項 | may |
| 〜できる | 可能性・能力 | can |

#### 文書構成の原則
- 要求事項と説明・解説を明確に区別すること
- 各章・節には目的を明示すること
- 表には連番とキャプションを付与すること

---

## 第1章 適用範囲

### 1.1 目的

本ドキュメントは、ハウスクレジット基幹システムにおけるデータモデリングの共通方針を定め、各BC単位で作成される以下のドキュメント群に対し、上位方針として拘束力を持つことを目的とする。

* ドメインモデル概要書／集約一覧／集約仕様書
* リポジトリ一覧／リポジトリ仕様書
* テーブル一覧／テーブル仕様書
* プロジェクション一覧／プロジェクション仕様書

本書で定義された方針に反するデータモデル・テーブル設計を行ってはならない。

### 1.2 適用範囲

**表1 — 適用範囲**
| 項目 | 内容 |
|----|----|
| ドキュメント名 | データモデリング方針書 |
| 単位 | 全体（全BC共通） |
| 位置づけ | データ設計に関する最上位方針ドキュメント |
| 主な参照先 | ドメインスコープ定義書、コンテキストマップ、トランザクション方針書、ロギング／監査方針書、セキュリティ非機能要件定義書 |

### 1.3 前提アーキテクチャ

本方針書は、DDD（ドメイン駆動設計）に基づくレイヤードアーキテクチャを前提とし、ドメインモデル（集約／エンティティ／VO）、永続化モデル、ビュー／プロジェクションの三層に適用される。\
本方針書は、「ドメインスコープ定義書」「コンテキストマップ」で定義された全てのBCを適用対象とし、Core／Supporting／Genericの種別に関わらず統一的に適用しなければならない。\
データモデリングに関するより詳細な仕様（項目一覧・型・制約・インデックス等）は、テーブル仕様書およびリポジトリ仕様書にて定義しなければならない。

**表2 — 適用対象**
| 区分 | 内容 |
|----|----|
| 適用対象 | 全BCのデータモデル（集約モデル／永続化モデル／プロジェクション） |
| 非適用（参照） | トランザクション制御、ログ出力フォーマット、インフラ構成 |
| 前提アーキテクチャ | DDD＋BC単位マイクロサービス（予定） |

### 1.4 関連文書

**表3 — 関連文書一覧**
| 関連ドキュメント | 関係性 |
|----------------|--------|
| ドメインスコープ定義書 | BC構造・境界の定義をインプットとする |
| コンテキストマップ | BC間関係の定義をインプットとする |
| トランザクション方針書 | トランザクション境界・整合性方針を参照 |
| セキュリティ方針書 | データ分類・暗号化方針を参照 |
| アプリケーションログ方針書 | 監査証跡方針を参照 |

---

## 第2章 引用規格

本書は以下の規格・標準を参照する：

- ISO/IEC 11179 メタデータレジストリ
- Domain-Driven Design (Eric Evans)

---

## 第3章 用語及び定義

**表4 — 用語定義**
| 用語 | 定義 |
|------|------|
| 集約（Aggregate） | 整合性境界を形成するエンティティ・VOの集まり |
| 集約ルート | 集約への唯一のアクセスポイントとなるエンティティ |
| VO（Value Object） | 識別子を持たず、属性の組み合わせで同一性が判定されるオブジェクト |
| プロジェクション | 参照用途に最適化された非正規化ビュー |
| サロゲートキー | ビジネス上の意味を持たない技術的識別子 |

---

## 第4章 入力情報と前提

### 4.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 4.2 前提条件

* 本方針書は、「ドメインスコープ定義書」「コンテキストマップ」「トランザクション方針書」で定義された **BC構造・境界・整合性方針が確定していること** を前提とする。
* データモデルは、DDDのレイヤードアーキテクチャ（ドメインモデル／永続化モデル／プロジェクション）の分離に従うことを前提とし、**業務ロジックと物理構造を同一層に混在させてはならない**。
* セキュリティ方針・セキュリティ非機能要件定義書で定義される **データ分類・暗号化・アクセス制御ルールが適用されること** を前提とし、本書ではその上位原則に従う。
* ロギング／監査方針書で定義される **監査項目・証跡保持・ログ方針** が有効であり、データモデルにはこれらを反映する前提とする。
* 非機能要件定義書で定義される **性能・可用性・保管期間・容量計画** が前提条件として確立されており、モデリング判断（正規化レベル、履歴分割、プロジェクション構造等）はこれらの非機能要求に整合させる。
* BC間データ連携方式（API／Event／Batch）は、「非同期連携方針書」「APIガバナンス方針書」に従って設計されることを前提とし、**クロスBCの直接参照やテーブル共有は許容しない**。
* モデルに用いる語彙・属性名は「ユビキタス言語定義書」「VO定義書」を前提とし、**命名の統一性と意味の一貫性** を保持する。
* バックアップ／リストア・災対・アーカイブ戦略は「運用要件定義書」「システム構成方針書」で管理される前提とし、本書はその前提を満たすデータモデルを定義する。
* 各BCは自律性を持つマイクロサービス（想定）として設計され、**データモデルはBC単位で独立して管理されること** を前提とする。

---

## 第5章 データモデリング共通方針

### 5.1 モデルレイヤ分離方針

データモデルは、少なくとも以下のレイヤに分離して定義しなければならない。

* ドメインモデル（集約／エンティティ／VO）
* 永続化モデル（テーブル／ドキュメント／キー値ストア等）
* プロジェクション／ビュー（画面・帳票・外部IF向け）

ドメインモデルと永続化モデルの乖離が必要な場合、乖離理由（性能要件、外部IF制約等）をリポジトリ仕様書に明示しなければならない。\
プロジェクション／ビュー用の冗長なデータ構造は、読み取り専用であることを明示し、更新は必ず集約経由で行わなければならない。

**表5 — モデルレイヤ定義**
| レイヤ | 説明 | 主な記述ドキュメント |
|-----|----|------------|
| ドメインモデル | 業務ロジックの一貫性境界（集約単位）を表現 | ドメインモデル概要書／集約仕様書 |
| 永続化モデル | DB上の物理／論理構造 | テーブル一覧／テーブル仕様書／リポジトリ仕様書 |
| プロジェクション | 参照用途に最適化された冗長ビュー | プロジェクション一覧／仕様書 |

### 5.2 BC・集約とデータモデルの対応方針

各BCは、コンテキストマップで定義された整合境界に従い、BCをまたぐテーブル共有を原則禁止しなければならない。\
1つの集約は、原則として1つの永続化ルート（テーブルまたはドキュメント）を持つものとし、複数テーブルに跨る場合は、同一BC内で完結するように設計しなければならない。\
BC間のデータ連携は、イベント／API／外部連携一覧で定義されたインタフェースを通じてのみ行い、同一DBスキーマへのクロスBC直接参照を禁止しなければならない。

**表6 — BC・集約とデータモデルの対応**
| 対応関係 | 方針 |
|------|----|
| BC ↔ スキーマ | 1 BC = 1 もしくは少数の論理スキーマを原則とし、スキーマ共有は例外として扱う |
| 集約 ↔ テーブル群 | 集約ルートごとに永続化ルートを定義し、BC内に閉じた整合性を確保する |
| BC間 | イベント／API経由での連携のみ許容する |

### 5.3 命名規約・識別子・キー選定

すべての集約ルートおよび主要エンティティは、ドメイン上の自然キーと独立した技術的識別子（サロゲートキー）を持たなければならない。\
技術的識別子は、BCを跨いで一意である必要はないが、当該BC内では一意となるよう設計しなければならない。\
テーブル・カラムの命名規約は「ユビキタス言語／VO定義書」で定義された用語に基づき、略語や多義的な名称を使用してはならない。

**表7 — 命名規約・識別子方針**
| 対象 | 方針 |
|----|----|
| 集約ルートID | BC内で一意な技術ID（数値 or UUID 等）を必須とする |
| 自然キー | ビジネス上のキー（カード番号、会員番号等）は別VOとして保持する |
| 命名 | ユビキタス言語を優先し、システム固有略語を禁止する |

---

## 第6章 データ永続化方針（履歴・改訂・整合性）

### 6.1 履歴管理・改訂方針

発券済カード情報・限度額情報など、後続ドメイン（売上・請求・債権）に影響する確定データは、原則として履歴追記方式を採用し、確定済レコードの上書き更新を禁止しなければならない。\
履歴管理が必要なテーブルは、有効開始日／終了日、改訂理由、改訂者等の監査項目を保持するようモデリングしなければならない。\
履歴テーブルと現行テーブルを分離する場合、その対応関係をテーブル仕様書に明示しなければならない。

**表8 — 履歴管理方針**
| 対象データカテゴリ | 履歴方式 | 備考 |
|-----------|------|----|
| カード／契約状態 | 有効期間管理＋履歴追記 | CP-003 データ改訂ポリシーを参照 |
| 限度額 | 有効期間管理＋履歴追記 | 過去限度の追跡が可能であること |
| マスタ（コード等） | 案件に応じて選択 | 参照系のみの場合は履歴不要も可 |

### 6.2 整合性・参照制約方針

外部キー制約は、BC内の整合性担保に限定して利用し、BC間の参照はアプリケーションレベルの整合性により担保しなければならない。\
Invariant（不変条件）は、可能な限りデータモデル上の制約（NOT NULL、UNIQUE、CHECK 等）で表現し、それが困難な場合はドメインサービス／アプリケーションサービスでの検証ルールとして定義しなければならない。\
論理削除フラグを利用する場合は、削除レコードを除外したいユースケースにおいて必ず条件句に含めるよう、リポジトリ仕様書／クエリ仕様書に明記しなければならない。

**表9 — 整合性・参照制約方針**
| 区分 | 方針 |
|----|----|
| BC内FK | 積極的に利用し、一貫性をDB制約で担保する |
| BC間FK | 原則禁止。BC間はイベント／APIを通じた整合性とする |
| 不変条件 | 可能な限りDB制約＋ドメインルールの二重防御とする |

### 6.3 削除・アーカイブ方針

監査／法規制に関わるデータは、保管期間満了までは論理削除を原則とし、物理削除を行ってはならない。\
物理削除が認められるのは、個人情報保護等の観点で削除義務があるデータに限定し、その対象・条件をテーブル仕様書で明示しなければならない。\
大量データの長期保管が必要な場合、アーカイブ用ストレージ／スキーマへの移送方針を別途定義し、その前提条件を本書に記載しなければならない。

**表10 — 削除・アーカイブ方針**
| 項目 | 方針 |
|----|----|
| 論理削除 | 保管義務のあるデータの基本方式とする |
| 物理削除 | 法令等で削除義務があるデータに限定する |
| アーカイブ | 性能・容量要件に応じて別スキーマ／別ストレージに退避する |

---

## 第7章 セキュリティとアクセス制御（データ観点）

### 7.1 データ分類・マスキング

データは、セキュリティ非機能要件で定義される情報分類（例：極秘／機微／社外秘等）に従って分類し、その分類に応じた暗号化・マスキング要件をテーブル仕様書に反映しなければならない。\
カード番号・口座番号・個人識別情報（氏名・生年月日等）は、画面・帳票・ログ出力時に必要最小限の桁のみ表示されるよう、プロジェクション／ビューの項目定義に反映しなければならない。\
マスキング前の原データは、暗号化またはトークナイズされた形で保存することを基本とし、平文保存を行ってはならない。

**表11 — データ分類・マスキング方針**
| 項目 | 方針 |
|----|----|
| 情報分類 | セキュリティ非機能要件に従い付与する |
| 機微情報 | 暗号化保存＋表示時マスキングを必須とする |
| ログ出力 | ロギング／監査方針書の出力ルールに従う |

### 7.2 アクセス制御・権限モデル

テーブル／ビューへのアクセスは、共通運用管理ドメインの組織・ユーザ管理で定義される権限モデルに基づき制御しなければならない。\
業務ユーザごとのアクセス範囲（顧客単位・加盟店単位等）は、データモデル上の組織単位／テリトリ等の属性と紐付けて設計しなければならない。\
アプリケーション層での権限チェックだけに依存せず、必要に応じてビュー単位・スキーマ単位のアクセス制御を併用しなければならない。

**表12 — アクセス制御方針**
| 対象 | 方針 |
|----|----|
| 認可基盤 | 共通運用管理ドメインの組織・ユーザ管理を利用する |
| 行レベル権限制御 | 担当者・組織・テリトリ等の属性で制御可能なモデルとする |
| スキーマ権限制御 | BC単位にスキーマを分離し、不要な参照を防止する |

### 7.3 監査証跡項目のモデリング

操作履歴・監査証跡は「ロギング／監査方針書」「監査・業務ログ一覧」が主責であるが、業務データ側でも作成者／更新者／作成日時／更新日時等の最低限の監査項目を持たなければならない。\
改訂履歴を保持するテーブルでは、監査ログと合わせて誰が・いつ・どの値からどの値へ変更したかが追跡可能となるよう設計しなければならない。\
監査証跡の保管期間・参照方法は、ロギング／監査方針書との整合を取って定義しなければならない。

**表13 — 監査証跡方針**
| 項目 | 方針 |
|----|----|
| 作成者／更新者 | 全更新系テーブルで保持する |
| 変更内容の追跡 | 履歴テーブル＋監査ログの両方で追跡可能とする |
| 監査ログ連携 | ロギング／監査方針書の定義に従う |

---

## 第8章 データライフサイクル・保管期間方針

### 8.1 データカテゴリ別ライフサイクル

データのライフサイクルは、ドメインスコープ定義書で定義された各ドメイン／サブドメインの責務に基づき、「生成→更新→参照→アーカイブ／削除」の流れを定義しなければならない。\
取引（売上・請求・入金・債権）データは、債権管理・会計統合・監査要件を満たす期間中は参照可能な状態を維持しなければならない。\
ポイントやキャンペーンなどの補助データについても、関連する取引や会計処理に影響する期間は削除してはならない。

**表14 — データライフサイクル**
| データカテゴリ | ライフサイクル上の主なステージ |
|---------|-----------------|
| 顧客／契約 | 申込→審査→契約→解約→保管終了 |
| カード発行 | 申込→発行→更新／再発行→解約→保管終了 |
| 売上・請求・入金 | 発生→確定→精算／回収→保管終了 |
| ポイント | 付与→利用→失効→保管終了 |

### 8.2 保管期間・アーカイブ・削除

各データカテゴリの保管期間は、法令・契約・社内規程に基づき「セキュリティ非機能要件定義書」「運用要件定義書」で定義し、それを本書に反映しなければならない。\
アーカイブによってオンライン系DBから退避したデータは、検索・復元に必要なキー情報を保持した状態で保存しなければならない。\
保管期間満了後の削除処理は、バッチ一覧／バッチ仕様書で詳細を定めるものとし、その前提条件を本書で定義しなければならない。

**表15 — 保管期間方針**
| 区分 | 方針 |
|----|----|
| 保管期間 | データカテゴリごとに年数等を別途定義する |
| アーカイブ | オンライン系DBから分離しつつ、検索・復元可能性を維持する |
| 削除 | 保管期間満了後のバッチ処理として実施する |

### 8.3 バックアップ・リストア観点の前提

バックアップ・リストア手順そのものはシステムIaC構成定義書等の範囲とするが、リストア後も論理キーで一意に業務データを識別できるようデータモデルを設計しなければならない。\
履歴テーブル・監査ログとの整合が崩れないよう、バックアップ対象範囲とスキーマの整合条件をデータモデリング上の前提として定義しなければならない。

**表16 — バックアップ・リストア前提**
| 項目 | 方針 |
|----|----|
| 論理キー | バックアップ／リストア後も変化しない識別子を採用する |
| 一貫性 | 履歴・監査テーブルとの整合が保てる粒度でバックアップする |

---

## Stop（入力不足に対する質問）

（入力情報が不足している場合、ここに質問を記載する）

---

## 論点（検討が必要な事項）

（検討が必要な論点がある場合、ここに記載する）
