あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】に基づいて、対象システムの「APIガバナンス方針書」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。

### 【形式】

第〇章：##\
〇.〇：###\
小見出し：####\
その他：通常テキスト\
表はMarkdown表形式で記載\
JSON / CSV形式は禁止

---

### 第1章：目的・位置付け

#### 1.1 本書の目的

本書は、ハウスクレジット基幹システムにおける全API（同期API／非同期API／イベントAPI／バッチAPI／BFF／Process API／External Public API／ファイル連携API）の設計・運用・保守・廃止に関する共通ルールおよび判断基準を定義し、\
境界づけられたコンテキスト（BC）単位の自律性と、システム全体の整合性の両立を図ることを目的とする。

#### 1.2 本書の位置付け

本書は「システム全体方針検討」に属するアーキテクチャ指針であり、コンテキストマップ／ドメインスコープ定義書／構成・運用方針書をインプットとして作成される。\
本書はAPI仕様そのものではなく、「APIをどのように設計・管理・公開するか」のメタルールを定める。\
個々のAPI仕様（OpenAPI／AsyncAPI／Batch仕様など）は、本書の方針に従って別途作成・管理される。

---

## 第2章 入力情報と前提

### 2.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 2.2 前提条件

* 本方針書は、「コンテキストマップ」「ドメインスコープ定義書」「構成・運用方針書」など、BC構造およびシステム全体構成が定義された資料を前提とする。
* APIは、DDDのBounded Context単位でモデリングされたドメイン構造に基づき設計されることを前提とし、BC一覧およびユビキタス言語定義は別途ドキュメントで管理される。
* 本方針書は「APIの設計・管理・公開」に関するメタルールを対象とし、個々のAPI仕様（OpenAPI／AsyncAPI／Batch仕様／ファイル仕様等）の詳細は、各API仕様書で定義されることを前提とする。
* 認証・認可、ゼロトラスト、ネットワーク境界、暗号化方式などのセキュリティ要件は、「セキュリティ方針」「セキュリティ非機能要件定義書」「認証・認可方針書」にて定義され、本方針書はそれらと整合して運用される。
* 可用性・性能・スループット・レートリミット等の数値基準は、「非機能要件定義書」「性能定義書」で定義され、本方針書ではそれらの値を満たす設計・実装を行うことを前提とする。
* ログ・監査・メトリクス・トレースなどの可観測性要件は、「ロギング／監査方針書」「運用要件定義書」「監査・業務ログ一覧」等で定義され、本方針書ではAPIレベルでそれらを満たすように設計することを前提とする。
* 外部システムとのインタフェース要件（銀行口座振替API、外部信用情報機関、会計システム等）は、各外部仕様書および連携方針書にて定義され、本方針書はそれらとの契約をAPIガバナンスの対象として扱うことを前提とする。

---

## 第3章：適用範囲

### 3.1 対象システム・BC

#### 3.1.1 対象システム
| 項目 | 記述内容 |
|----|------|
| 対象システム | ハウスクレジット基幹システム |
| 対象BC | ドメインスコープ定義書およびコンテキストマップに定義された全BC |
| 除外対象 | 未確定（PoC／一時検証APIは例外承認対象とする想定だが詳細運用ルールは未確定） |

#### 3.1.2 対象BC一覧（コンテキストマップより）
| \# | ドメイン | サブドメイン | BC | BC概要 |
|----|------|--------|----|------|
| 1 | 売上管理 | 売上取込 | 売上取込BC | ブランド/ネットワークからの売上受入・重複/形式チェック。 |
| 2 | 売上管理 | 売上確定 | 売上確定BC | 審査後の売上確定・取消制御・請求連携の起点。 |
| 3 | 売上管理 | オーソリ反映 | オーソリ反映BC | オーソリ結果・解約等に伴う即時利用可否反映。詳細未確定。 |
| 4 | 会員精算管理 | 請求管理 | 請求BC | サイクル集計・請求締め・会計連携候補の生成。 |
| 5 | 会員精算管理 | 入金管理 | 入金BC | 口座振替/全銀振込の結果取込・消込・未収管理。 |
| 6 | 会員精算管理 | 返金処理 | 返金BC | 返金起案/承認/実行と結果反映。 |
| 7 | ポイント管理 | ポイント管理 | ポイントBC | 売上連携によるポイント付与/利用/失効・履歴管理。 |
| 8 | 審査発行管理 | 与信審査 | 審査BC | 申込〜eKYC/信用照会〜審査判定。 |
| 9 | 審査発行管理 | カード発行 | 発行BC | 発番・印刷・発送・受領管理。 |
| 10 | 加盟店契約管理 | 契約/審査 | 加盟店契約BC | 加盟店申請→名寄せ→登録、属性/契約変更・停止/解約。 |
| 11 | 加盟店契約管理 | 契約/審査 | 加盟店審査BC | 加盟店審査・外部信用情報機関への照会。 |
| 12 | 会計統合管理 | 日計/会計連携 | 日計管理BC | 仕訳基準・日計管理。 |
| 13 | 会計統合管理 | 日計/会計連携 | 会計連携BC | 会計連携用I/F加工（外部会計システム連携）。 |
| 14 | 共通運用管理 | 共通マスタ/日付 | 共通マスターBC | 住所・金融・コード・休日など共通マスタ。全ドメイン参照。 |
| 15 | 共通運用管理 | 共通マスタ/日付 | 運用日付BC | システム日付等の運用日付管理。 |
| 16 | 顧客管理 | 顧客 | 顧客BC | 顧客基本情報管理。詳細未確定。 |
| 17 | 顧客管理 | 連絡先・住所 | 連絡先・住所BC | 顧客の連絡先・住所情報管理。共通マスターBCとShared Kernel。 |
| 18 | 顧客管理 | 解約 | 解約BC | 解約登録・利用停止トリガ管理。 |

備考：上記BCのうち、#1〜#15はコンテキストマップ第2章の一覧から、#3, #16〜#18はMermaid図および関係定義から抽出。

### 3.2 APIの定義と本方針の対象範囲

#### 3.2.1 APIの定義

本書における「API」とは、次のすべてを含む広義のインタフェースと定義する。

* システム間・BC間の機能・データを**契約（Contract）**として公開し、連携するためのインタフェース全般
* HTTP/REST API、RPC、GraphQL、メッセージング／イベント配信（Kafka等）、バッチ連携、ファイル連携（CSV／XML／固定長など）、SFTP連携等を含む

#### 3.2.2 API種別とガバナンス対象
| API種別（統一） | 含まれる対象例（本システム文脈） | ガバナンス上の扱い |
|-----------|------------------|-----------|
| Domain API | 売上確定BCの確定・取消操作、請求BCの請求締め操作 等 | 集約単位・ユースケース単位で契約を定義し、仕様レビュー対象とする。 |
| Process API | 売上確定→請求生成フロー、審査承認→発行フローなどBC横断処理 | 複数BCや外部APIのオーケストレーション・例外処理・統合フロー管理を担う。 |
| BFF | Web/アプリ向け会員請求照会API、ポイント照会画面用API 等 | UI最適化・プレゼンテーション層専用。ビジネスロジックは禁止。 |
| External Public API | 銀行口座振替APIとの連携I/F、外部信用情報機関照会I/F、加盟店向け売上照会API 等 | セキュリティ／SLA／公開レベル（Public/Partner/Internal）の管理対象。 |
| Event API | 売上確定イベント、請求確定イベント、入金結果イベント 等 | イベントスキーマ定義・発生契機・Pub-Sub契約の管理対象。 |
| Batch API / File連携 | 会計連携用バッチIF、全銀振込結果ファイル取込、日計出力 等 | スキーマ／受渡方式／再処理条件／ファイル形式の契約として扱う。 |

上記はすべてAPI契約として扱い、本方針の適用対象とする。\
具体的なプロトコルやフォーマットは一部未確定とし、別途仕様で定義する。

---

## 第4章：API基本方針（DDD/BCとの関係）

### 4.1 DDD／コンテキストマップとの整合

#### 4.1.1 APIとBC境界の基本原則
| 原則 | 説明 |
|----|----|
| 境界尊重 | APIは、BC内部のドメインモデルを他BCに直接公開してはならない。必要に応じてACL／翻訳層（Anti-Corruption Layer）を設ける。特に、外部会計システム・銀行口座振替API・外部信用情報機関などとの連携はACLパターンを前提とする。 |
| 責務分離 | Domain APIは単一BC内部で完結する操作のみを提供し、売上確定→請求生成や審査→発行などBC横断の責務はProcess APIに委任しなければならない。 |
| ユビキタス言語整合 | APIで使用する語彙は、各BCのユビキタス言語およびVO辞書と整合させる。外部仕様や他システム由来の用語を安易に持ち込まず、必要に応じて翻訳層で吸収する。 |
| アーキテクチャ適合 | API設計はコンテキストマップで定義された関係（ACL／Shared Kernel／Separate Ways 等）と整合していなければならない。Shared Kernel（連絡先・住所BCと共通マスターBC）を利用する個所では共通スキーマの破壊を避ける。 |

#### 4.1.2 API種別とBC境界の対応
| API種別 | BCとの関係 | 設計上の注意点 |
|-------|--------|---------|
| Domain API | 単一BC内 | 売上取込BC／売上確定BC／請求BCなど、1つのBC内部のユースケースを集約単位で提供する。BC内部境界を越えないこと。 |
| Process API | BC横断 | 売上確定BC→請求BC、入金BC→請求BC、審査BC→発行BC、解約BC→オーソリ反映BCなど、BC間のオーケストレーションを実装する。リトライ／補償処理もProcess API側で管理する。 |
| BFF | BC境界外 | 顧客向けUI／加盟店向けUIのための集約ビュー提供に特化し、ビジネスルールはBCまたはProcess API側に保持する。 |
| External Public API | BC外部 | 銀行口座振替API、全銀振込、外部信用情報機関、会計システムなどとのIFは、ACLパターンに従いBC外部の境界として扱う。公開レベルと責務を明確にする。 |
| Event API | BC横断（疎結合） | 売上確定や請求確定などの状態変化をイベントとして発行し、他BC（請求BC、会計連携BC、ポイントBCなど）が購読する構造を想定する。イベント名・契機はイベントストーミングと整合させる。 |
| Batch API | BC横断／外部 | 会計連携BC→会計システム、入金BC↔銀行システム等の定期連携やファイル受渡しを担当する。再処理条件やファイル管理は契約に明示する。 |

#### 4.1.3 コンテキストマップとの整合ルール

API設計時には、必ずコンテキストマップを参照し、以下を確認しなければならない。
| 確認項目 | 説明 |
|------|----|
| 境界タイプの確認 | コンテキスト間の関係がACL／Shared Kernel／Separate Waysのどれに該当するかを明確にする。ACLの場合は翻訳・保護責務をAPI設計に反映する。 |
| モデル依存の確認 | 他BCのドメインモデルを直接参照する必要がある場合はShared KernelかACLかを判断し、必要に応じて専用のVOやDTOを定義する。 |
| イベント共有の可否 | 売上確定→請求生成、入金結果→請求更新などイベント共有が発生する箇所について、イベント形式とVOの整合性を保証する。 |
| 変更影響管理 | API変更が他BCまたは外部システムに影響を与える場合、コンテキストマップを用いて影響範囲を洗い出し、レビューおよび影響分析を行う。 |

#### 4.1.4 DDD観点でのAPI設計判断例（本システム文脈）
| ケース | 正しいAPI種別の例 | 誤りやすい設計 |
|-----|------------|---------|
| 売上確定後に請求を生成する処理 | 売上確定BC・請求BCを跨ぐProcess API＋必要に応じてEvent API | 売上確定BCのDomain APIから直接請求更新を行う |
| 売上取込に応じたポイント付与 | 売上取込BCからポイントBCへのEvent API＋ポイントBCのDomain API | 両者を1つの巨大なDomain APIに押し込む |
| 審査承認後にカード発行を行う処理 | 審査BC・発行BCを束ねるProcess API | 発行BCが審査ロジックまで保持する |
| 解約登録に伴うオーソリ即時停止 | 解約BC→オーソリ反映BCのProcess APIまたはEvent API | オーソリ反映BCが顧客管理ロジックを直接持つ |
| 会計連携（請求確定データの会計システム出力） | 会計連携BCのBatch API／File連携API | 調請求BCから会計システムに直接REST連携する |

### 4.2 API種別ごとの責務・設計原則
| API種別 | 責務 | 設計原則（Shall/Must） |
|-------|----|------------------|
| Domain API | 集約／ユースケース | 集約の不変条件を守り、DDDモデルと整合したAPI設計でなければならない。1つのDomain APIで複数BCの責務を扱ってはならない。 |
| Process API | 業務フロー | BC横断の調整を担い、業務フロー単位で契約を定義しなければならない。Saga／補償トランザクション等の制御もProcess API側で明確化する。 |
| BFF | UI適合 | UI専用APIとして、ビジネスロジックを含んではならない。レスポンス整形・集約・フィルタリングなどプレゼンテーションロジックに限定する。 |
| External Public API | 外部提供 | 公開レベル（Public／Partner／Internal）を区分管理しなければならない。契約やSLA、利用制約を明示し、セキュリティ方針に従う。 |
| Event API | 状態通知 | イベント名・契機はイベントストーミング定義と整合しなければならない。重要イベントについてはバージョニングとスキーマ進化方針を定める。 |
| Batch API | データ交換 | ファイル形式とスキーマ、検証、再処理条件を含む契約を明示しなければならない。非機能要件（処理時間・件数上限等）は非機能要件定義書の値を参照する。 |

---

## 第5章：APIライフサイクル管理方針

### 5.1 ライフサイクルフェーズ
| フェーズ | 説明 | 必須アウトプット |
|------|----|----------|
| 企画 | API追加の目的・ビジネス価値を明確化し、外部公開・内部限定・コンテキスト境界・API種別（Domain/BFF/Process/Event/Batch）を判定するフェーズ。 | API企画書（テンプレート・必須項目は未確定） |
| 設計 | API契約（仕様）を定義し、形式（OpenAPI/AsyncAPI/Batch仕様など）と公開レベル（Internal/Partner/Public）を設計する。仕様書はレビューを完了しなければならない。 | API仕様書 |
| 実装・テスト | API仕様に基づいて実装し、SBE・シナリオテストを用いて機能・性能・セキュリティ要件を検証しなければならない。 | 実装コード、テスト結果 |
| リリース | 本番環境へのデプロイと公開範囲の設定を行い、APIポートフォリオを更新しなければならない。 | リリース記録、APIカタログ更新記録 |
| 廃止 | API廃止やバージョン削除に際し、利用者への通知・移行期間・代替APIを定義しなければならない。 | 廃止計画・告知記録 |

### 5.2 バージョニング方針
| 項目 | 要求事項 |
|----|------|
| バージョン表現 | URI / ヘッダ / メッセージ形式のいずれかによる表現方式は未確定とし、プロジェクトで統一ルールを定義しなければならない。 |
| 後方互換 | 互換性を破る変更はメジャーバージョンアップとし、旧バージョンは移行期間中並行提供しなければならない（具体期間は未確定）。 |
| 廃止告知 | 廃止時は、少なくとも未確定期間以上前に利用者（内部・外部）に通知しなければならない。期間は別途決定。 |
| スキーマ進化 | 後方互換な修正（フィールド追加等）は、スキーマの互換性検証（ツール・レビュー）を通過しなければならない。 |

---

## 第6章：API仕様標準方針

### 6.1 仕様形式・管理方法
| 項目 | 記述内容 |
|----|------|
| 仕様形式 | OpenAPI / AsyncAPI / GraphQL SDL / Batch仕様（契約書形式）等から採用形式を選定し、本書に明記しなければならない。現時点の採用形式は未確定。 |
| 管理リポジトリ | API仕様はGit等のバージョン管理システムで管理し、変更履歴を追跡可能としなければならない。BC単位またはドメイン単位でのリポジトリ構成は未確定。 |
| レビュー要件 | API仕様の新規作成・変更は必ずレビューを通過し、定められたロール（例：ドメインアーキテクト／BCオーナー）が承認しなければならない。具体ロールは未確定。 |

### 6.2 命名規約・URI設計
| 項目 | 要求事項 |
|----|------|
| ベースパス | システム全体で統一されたベースパス方針（例：/api/v{version}、/internalと/externalの区分など）を定めなければならない。具体値は未確定。 |
| リソース名 | ケバブケース・複数形などプロジェクト標準に従って統一しなければならない。ドメインのユビキタス言語と整合していること。 |
| フィールド名 | ユビキタス言語VO定義書に基づき命名しなければならない。外部システム由来の名称を利用する場合は、翻訳ルールを明文化する。 |
| ステータスコード | HTTPステータスコードの利用ルール（2xx, 4xx, 5xxの使い分け）を定義し、それに従わなければならない。各業務エラーに対する標準マッピング表は未確定。 |

---

## 第7章：APIセキュリティ・アクセス制御方針

本章は「セキュリティ方針」「セキュリティ非機能要件定義書」の参照が主であり、API固有の補足のみを記載する。

### 7.1 認証・認可の適用
| 項目 | 要求事項 |
|----|------|
| 認証方式 | 具体的な方式（OIDC／OAuth2.0／Mutual TLS／Basic認証等）はセキュリティ方針を参照すること。外部公開API（銀行口座振替API・加盟店向けAPI等）は認証必須とする。 |
| 認可スコープ | API単位で必要な権限（読取／更新／管理等）を定義し、API仕様書に明示しなければならない。BCごとに標準ロール・権限セットを整理すること（詳細未確定）。 |
| ゼロトラスト | 内部APIであっても、ネットワーク境界やBC境界を越える通信には認証と認可を適用しなければならない。トラストゾーン設計はセキュリティ方針を参照。 |

### 7.2 伝送路・入力検証
| 項目 | 要求事項 |
|----|------|
| 通信経路の保護 | TLS等の暗号化方式はセキュリティ方針を参照し、すべてのAPI通信（External / Internal / Batch転送含む）がその要件を満たさなければならない。 |
| 入力検証 | API入力はスキーマに基づいてサーバ側で検証し、不正入力を拒否しなければならない。Domain APIではドメインルールに基づく検証も行う。 |
| 機微情報の取扱い | 個人情報・金融情報等の機微データのマスキング／ログ抑止／暗号化要件はセキュリティ方針・個人情報保護方針を参照する。 |

---

## 第8章：API品質・非機能方針

数値基準は「非機能要件定義書」「性能定義書」を参照すること。

### 8.1 性能・可用性・スロットリング
| 項目 | 要求事項 |
|----|------|
| 性能基準の参照 | 各APIは非機能要件定義書の性能目標（レスポンス時間、同時接続数、スループット等）を参照し、それに基づき設計しなければならない。BCごとの性能ランクは未確定。 |
| スロットリング | 外部公開APIに対してはスロットリング／レートリミット方針を定義しなければならない（具体値は未確定）。Process APIを介した連携であっても、外部システムに対する呼出回数制御を行う。 |
| 可用性 | 可用性の目標値は性能定義書に従い、本書では「当該値を満たす設計義務」を定める。BCごとにRPO/RTOやDR要件が異なる場合は別途整理する。 |

### 8.2 可観測性・ログ
| 項目 | 要求事項 |
|----|------|
| メトリクス | APIリクエスト数、エラー率、レイテンシ等を収集しなければならない。メトリクスの定義・閾値は監査方針書／運用設計書を参照。 |
| トレース | 分散トレーシングの適用有無は未確定とし、適用する場合は全APIで一貫性を持たせる。トレースIDの伝播ルールは別途定義する。 |
| ログ方針 | APIアクセスログ・監査ログの項目・保管期間はロギング／監査方針書を参照する。イベントAPI／Batch APIも、成功・失敗・再処理状況を追跡可能なログを出力しなければならない。 |