あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】に基づいて、対象システムの「アプリケーションログ方針書」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。

---

**【形式】**\
`第〇章：##`\
`〇.〇：###`\
`小見出し：####`\
その他：通常テキスト\
表はMarkdown表形式で記載\
JSON / CSV形式は禁止

---

## 第1章：文書概要

### 1.1 目的

本書は、DDD（Domain-Driven Design）に基づいて構築されるハウスクレジットカードサービスシステムにおけるアプリケーションログおよび監査ログの方針を定義することを目的とする。

本書で定義する方針は、以下を満たさなければならない（Must）。

* 障害解析・性能分析・業務トラブル調査に必要な情報が取得できること
* 法令・社内規程に基づく監査要件を満たすログが取得できること
* DDDの境界づけられたコンテキスト（BC）単位でログが追跡可能であること
* 非機能要求およびセキュリティ要求と整合していること

---

### 1.1 記載項目（例）
| 項目 | 内容 | 記載ルール |
|----|----|-------|
| 適用範囲 | アプリケーションログ／監査ログ | 技術ログは除外と明記 |
| 利用対象 | 開発者／アーキテクト／運用担当／監査担当等 | 必要に応じて追加 |

---

###  1.2 入力アセット

* 例外処理ポリシー 
* 非同期連携方針

### 1.3 前提条件

* BC単位で完結するモデル化を行う
* 他BCとの関係は「参照」に留め、統合しない
* 技術実装前提の情報（DB、API、UI等）は扱わない

---

## 第2章：入力情報と前提

### 2.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 2.2 前提条件

* ログは **BC単位で追跡可能であること** を基本原則とする：未確定
* ログ整合性（ID、時刻、追跡キー）は全システム共通要素により統制される：未確定
* PII／センシティブ情報はログに直接残さず、マスキング／トークナイズを行う：未確定
* 外部IFログ・監査ログの詳細項目は別資料で定義される：未確定
* ログ保管・保護方式（WORM、署名等）は運用・セキュリティ側文書に依存する：未確定

---

## 第3章：用語定義およびログ分類

### 3.1 用語定義

本書で使用する主要な用語は、以下のとおり定義しなければならない。

#### 3.1 用語定義表
| 用語 | 定義 |
|----|----|
| アプリケーションログ | アプリケーションコードから出力されるログの総称。処理開始・終了、例外、外部IF呼出し等を含む。 |
| 監査ログ | 利用者・オペレータの行為および重要業務イベントを、後追い検証可能な形で記録したログ。 |
| BC（境界づけられたコンテキスト） | DDDにおいて意味的に一貫したモデルが成立する境界。カード会員管理、与信、請求など。 |
| ドメインイベント | ドメイン層における重要な状態変化を表すイベント。ログ出力対象の単位となり得る。 |
| コマンド | アプリケーション層で受け付ける操作要求。ユーザ操作／外部IF要求など。 |
| テクニカルログ | OS、ミドルウェア、ネットワーク機器等が出力するログ。原則、本書の対象外。 |

---

### 3.2 ログ種別・分類

システム内のログは、少なくとも以下の観点で分類しなければならない（Must）。

#### 3.2 ログ分類表
| 区分 | サブ区分 | 概要 | 主な出力レイヤ |
|----|------|----|---------|
| アプリケーションログ | トランザクションログ | BC単位の処理開始／終了、結果 | アプリケーション層 |
|  | エラーログ | 業務例外／システム例外 | アプリケーション／ドメイン層 |
|  | 外部IFログ | 外部システム呼出し要求／応答 | アプリケーション／インフラ層 |
| 監査ログ | 操作ログ | 利用者ログイン／画面操作／API操作 | アプリケーション層 |
|  | 権限・設定変更ログ | ロール付与・剥奪、マスタ設定変更 | 管理系BC、運用ツール |
|  | 重要イベントログ | 与信結果確定、契約締結等 | 各BCのドメイン層 |
| テクニカルログ | システムリソース | CPU、メモリ、ディスク等 | インフラ |

※ テクニカルログは本書では概要のみとし、詳細方針はインフラ運用文書側で定義する。

---

## 第4章：DDDアーキテクチャにおけるログ方針

### 4.1 レイヤ別ロギング方針

DDDにおけるレイヤ（プレゼンテーション／アプリケーション／ドメイン／外部フレームワーク）ごとに、ログ出力責務を以下の通り定義しなければならない。

#### 4.1 レイヤ別責務表
| レイヤ | ログ出力の主目的 | ログに含めるべき情報（例） |
|-----|----------|---------------|
| プレゼンテーション | リクエスト受付・レスポンス返却の記録 | リクエストID、ユーザID（マスク可）、エンドポイント、レスポンスコード 等 |
| アプリケーション | ユースケースの進行状況 | コマンド名、BC名、処理開始・終了、結果ステータス 等 |
| ドメイン | 重要なビジネスイベントの記録 | ドメインイベント名、影響対象エンティティID（マスク可） 等 |
| 外部フレームワーク | 外部IF・リソース利用状況 | 接続先システム、タイムアウト／エラー種別 等 |

各レイヤは、自身の責務に属さない情報を過度にログ出力してはならない（Must not）。

---

### 4.2 BC単位ロギング方針

BC単位での処理追跡性を確保するため、以下の方針を定めなければならない。

* 各BCは、コアなユースケースごとに **共通のトレーサビリティキー（例：リクエストID、トランザクションID等）** をログに含めなければならない。
* ドメインイベント発生時には、必ずアプリケーションログまたは監査ログにイベントを記録しなければならない。

#### 4.2 BC単位ログ方針
| 項目 | 記載内容 | 備考 |
|----|------|----|
| BC名 | 例：会員管理BC（確定） | 全BCについて記載 |
| 主要ユースケース | 例：入会申込登録 | 別途BC設計を参照 |
| トレーサビリティキー項目 | 例：リクエストID、会員ID（未確定） |  |
| ログ種別 | トランザクション／監査 等 | 複数選択可 |
| 重要ドメインイベントとログ出力有無 | イベント名＋出力要／不要 | イベント一覧は別文書 |

---

## 第5章：監査ログ方針

### 5.1 監査対象行為

監査ログは、法令・規制・社内規程上の要求に基づき、少なくとも以下の種別の行為を対象としなければならない（Shall）。

* 利用者認証／セッション管理に関する行為
* 権限・ロールの付与／剥奪／変更
* 重要業務イベント（契約締結、解約、限度額変更、与信結果確定 等）
* マスタデータやリスク関連パラメータの変更

#### 5.1 監査対象行為
| 区分 | 行為種別 | 監査ログ出力要否 | 備考 |
|----|------|----------|----|
| 認証・認可 | ログイン／ログアウト | 必須 | 失敗も含めること |
| 権限管理 | ロール付与／剥奪／変更 | 必須 | 実行者と対象者を記録 |
| 重要業務イベント | 与信結果確定 等 | 必須 | 各BCで具体化 |
| 設定変更 | マスタ／閾値変更 | 必須 | 旧値・新値をログ化可否を検討 |

---

### 5.2 監査ログ項目の最小要件

監査ログには、追跡性を確保するため、少なくとも以下の情報を含めなければならない（Must）。

#### 5.2 監査ログ最小項目
| 項目名 | 必須／任意 | 備考 |
|-----|-------|----|
| イベントID | 必須 | システム内で一意なID |
| 発生日時 | 必須 | タイムゾーンを統一 |
| 実行主体ID | 必須 | ユーザID、バッチID等 |
| 対象リソースID | 必須 | 会員ID、契約ID等（マスキング要検討） |
| 実行結果（成功／失敗） | 必須 | 失敗時はエラーコードも記録 |
| 実行環境情報 | 任意 | 端末種別、IPアドレス等 |

具体的な項目名・型・桁数は「監査・ログ一覧」等の別文書で定義しなければならない。

---

## 第6章：ログ保管・保護・アクセス制御方針

### 6.1 保管期間・保存形式

ログの保管期間は、法令・社内規程・契約要件を踏まえてBC／ログ種別ごとに定義しなければならない。

#### 6.1 保管ポリシー
| ログ種別 | 保管期間 | 保存形式（例） | 備考 |
|------|------|---------|----|
| アプリケーションログ | ○年 | テキスト／JSON 等 |  |
| 監査ログ | ○年 | WORM等 | 変更不可要件有無 |
| テクニカルログ | ○ヶ月 | 製品標準 | インフラ側で定義 |

---

### 6.2 アクセス制御・マスキング

ログへのアクセスは、職務分掌に応じて最小権限となるよう制御しなければならない（Must）。\
個人情報、カード情報等の機微情報は、ログ上では原則マスキングまたはトークナイズを行わなければならない。

#### 6.2 アクセス制御方針
| ロール | アクセス可能ログ種別 | 操作権限 | 備考 |
|-----|------------|------|----|
| 開発者 | 開発環境のアプリログのみ | 参照 | 本番ログ参照不可 |
| 運用担当 | 本番アプリ／監査ログ | 参照・検索 | ダウンロード制限有無 |
| 監査担当 | 本番監査ログ | 参照・エクスポート | 期間・用途を限定 |
| セキュリティ管理者 | 全種別（必要最小限） | 参照・設定変更 | セキュリティ方針参照 |

---

### 6.3 改ざん防止・監査証跡

* 監査ログについては、改ざん防止機構（WORM、デジタル署名、ハッシュチェーン等）の採用有無を定めなければならない。
* ログ削除・アーカイブといった管理操作自体も、別途監査ログとして記録しなければならない。

#### 6.3 改ざん防止方針
| 項目 | 方針 | 状態 |
|----|----|----|
| 改ざん防止方式 | WORM／署名／その他 |  |
| ログ管理操作の記録 | 削除／アーカイブ操作を監査ログに記録する | 要件 |
| ログ改ざん検知 | 定期的なハッシュ検証の実施有無 |  |

---

## 第7章：ログ運用・テスト方針

### 7.1 運用・監視での利用

* 運用担当は、ログを用いて障害検知・原因追跡を行えるようにしなければならない。
* どのログをどの監視ツールで監視するかは、監視設計書側で詳細定義し、本書では利用方針レベルに留める。

#### 7.1 運用利用方針
| 利用目的 | 利用するログ種別 | 詳細はどの文書で定義するか |
|------|----------|---------------|
| 障害検知 | アプリケーションエラーログ | 監視設計書 |
| 性能劣化検知 | 外部IFログ／処理時間ログ | 性能テスト計画書 |
| 不正アクセス検知 | 監査ログ | セキュリティ運用設計書 |

---

### 7.2 テスト観点

* ログ出力は、結合テスト／システムテスト／非機能テスト等で検証しなければならない。
* テストケースには、少なくとも「ログが出ること」「ログが出ないこと（不要な情報）」「マスキングが正しいこと」を含めなければならない。

#### 7.2 ログテスト観点
| テスト種別 | 観点 | 具体ケース例 |
|-------|----|--------|
| 機能テスト | 正常系イベントのログ出力 | 重要ユースケース単位 |
| 例外系テスト | エラーログ出力・情報漏えい防止 | 例外パターンごと |
| 非機能テスト | ログ量・性能への影響 | 負荷テスト時 |
| セキュリティテスト | マスキング・アクセス制御 | 権限別ログ参照可否 |