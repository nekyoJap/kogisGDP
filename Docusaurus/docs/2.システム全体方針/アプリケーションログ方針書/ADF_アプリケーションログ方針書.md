あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】および【ISO/IEC Directives Part 2準拠ルール】に基づいて、対象システムの「アプリケーションログ方針書」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。

---

### 【形式】

章：`## 第1章 タイトル`\
節：`### 1.1 タイトル`\
項：`#### 1.1.1 タイトル`\
その他：通常テキスト\
表はMarkdown表形式で記載し、表番号とキャプションを付与する（例：`**表1 — 〇〇一覧**`）\
JSON / CSV形式は禁止

---

### 【ISO/IEC Directives Part 2準拠ルール】

#### 要求事項の表現
出力文書では以下の表現を使い分けること：

| 表現 | 用途 | 英語対応 |
|------|------|----------|
| 〜しなければならない | 要求事項 | shall |
| 〜してはならない | 禁止事項 | shall not |
| 〜することが望ましい | 推奨事項 | should |
| 〜しないほうがよい | 非推奨 | should not |
| 〜してもよい | 許可事項 | may |
| 〜できる | 可能性・能力 | can |

#### 文書構成の原則
- 要求事項と説明・解説を明確に区別すること
- 各章・節には目的を明示すること
- 表には連番とキャプションを付与すること

---

## 第1章 適用範囲

### 1.1 目的

本書は、本システムにおけるアプリケーションログおよび監査ログの出力・管理・活用に関する共通方針を定めることを目的とする。\
本書の対象は、アプリケーションレイヤーで出力されるログ全般であり、インフラレイヤーのログ（OSログ、ミドルウェアログ等）は対象外とする。

### 1.2 適用範囲

**表1 — 適用範囲**
| 項目 | 記述内容 |
|----|------|
| 対象システム | ハウスクレジット基幹システム |
| 対象BC | ドメインスコープ定義書およびコンテキストマップに定義された全BC |
| 対象ログ | アプリケーションログ、監査ログ、業務ログ |
| 除外対象 | OSログ、ミドルウェアログ（運用要件定義書で管理） |

### 1.3 関連文書

**表2 — 関連文書一覧**
| 関連ドキュメント | 関係性 |
|----------------|--------|
| セキュリティ方針書 | PIIマスキング、改ざん防止方針を参照 |
| 例外処理ポリシー | 例外発生時のログ出力方針を参照 |
| ソフトウェアアーキテクチャ方針書 | レイヤ構成・責務配置を参照 |

---

## 第2章 引用規格

本書は以下の規格・標準を参照する：

- ISO/IEC 27001:2022 情報セキュリティマネジメントシステム
- NIST SP 800-92 Guide to Computer Security Log Management

---

## 第3章 用語及び定義

**表3 — 用語定義**
| 用語 | 定義 |
|------|------|
| アプリケーションログ | アプリケーション層で出力される技術的なログ |
| 監査ログ | セキュリティ・コンプライアンス目的で記録されるログ |
| 業務ログ | 業務処理の実行履歴・結果を記録するログ |
| トレースID | 分散システム全体で一意にリクエストを追跡するID |
| PII | Personally Identifiable Information（個人識別情報） |

---

## 第4章 入力情報と前提

### 4.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 4.2 前提条件

* ログ出力は構造化ログ（JSON形式等）を採用する：未確定
* 分散トレーシングの適用有無は別途インフラ設計で確定する：未確定
* ログ保管期間・保管先は運用要件定義書で確定する：未確定
* PIIマスキング方式はセキュリティ方針書に従う：未確定

---

## 第5章 ログ分類方針

### 5.1 ログ種別定義

**表4 — ログ種別定義**
| 種別 | 目的 | 主な用途 |
|-----|------|---------|
| アプリケーションログ | 技術的なデバッグ・障害調査 | 開発者・運用者 |
| 監査ログ | セキュリティ監査・コンプライアンス | 監査担当・セキュリティ |
| 業務ログ | 業務処理の追跡・確認 | 業務担当者 |

### 5.2 ログレベル定義

**表5 — ログレベル定義**
| レベル | 用途 | 出力条件 |
|-------|------|---------|
| FATAL | システム継続不能な障害 | 必須 |
| ERROR | エラー発生（処理継続可能） | 必須 |
| WARN | 警告（潜在的問題） | 必須 |
| INFO | 重要な業務イベント | 必須 |
| DEBUG | デバッグ情報 | 開発環境のみ |
| TRACE | 詳細トレース | 開発環境のみ |

---

## 第6章 ログ出力方針

### 6.1 レイヤ別ログ出力方針

**表6 — レイヤ別ログ出力方針**
| レイヤ | ログ出力方針 |
|------|-------------|
| アダプタ層 | 入口／出口ログを出力しなければならない |
| ユースケース層 | 業務処理の開始・完了・失敗を出力しなければならない |
| ドメイン層 | ログを出力してはならない（純粋なドメインロジック） |
| インフラ層 | 外部連携の結果・エラーを出力しなければならない |

### 6.2 必須出力項目

**表7 — 必須出力項目**
| 項目 | 説明 | 必須/任意 |
|-----|------|---------|
| timestamp | 出力日時（ISO 8601形式） | 必須 |
| level | ログレベル | 必須 |
| traceId | トレースID | 必須 |
| spanId | スパンID | 推奨 |
| userId | 操作ユーザーID | 必須（認証後） |
| message | ログメッセージ | 必須 |
| context | 追加コンテキスト情報 | 任意 |

---

## 第7章 監査ログ方針

### 7.1 監査対象イベント

**表8 — 監査対象イベント**
| イベント種別 | 例 |
|------------|-----|
| 認証イベント | ログイン、ログアウト、認証失敗 |
| 認可イベント | 権限変更、アクセス拒否 |
| データアクセス | 機微情報の参照・更新 |
| 設定変更 | システム設定の変更 |
| 管理操作 | ユーザー作成・削除、権限付与 |

### 7.2 監査ログ必須項目

**表9 — 監査ログ必須項目**
| 項目 | 説明 |
|-----|------|
| eventType | イベント種別 |
| timestamp | 発生日時 |
| userId | 操作ユーザーID |
| targetResource | 対象リソース |
| action | 実行アクション |
| result | 結果（成功/失敗） |
| sourceIP | 接続元IPアドレス |

---

## 第8章 PIIマスキング方針

### 8.1 マスキング対象

**表10 — マスキング対象**
| 対象データ | マスキング方式 |
|----------|---------------|
| カード番号 | 先頭6桁＋末尾4桁以外をマスク |
| 口座番号 | 末尾4桁以外をマスク |
| 氏名 | 完全マスク |
| 電話番号 | 末尾4桁以外をマスク |
| メールアドレス | ドメイン以外をマスク |
| パスワード | 出力禁止 |

### 8.2 マスキング実装方針

**表11 — マスキング実装方針**
| 項目 | 方針 |
|-----|------|
| 実装箇所 | ログ出力の共通処理で一元的に実施しなければならない |
| 例外処理 | マスキング処理失敗時は出力を抑止しなければならない |
| 監査 | マスキング前のデータをログに出力してはならない |

---

## 第9章 ログ保管・保護方針

### 9.1 保管期間

**表12 — 保管期間**
| ログ種別 | 保管期間 | 備考 |
|---------|---------|------|
| アプリケーションログ | 未確定 | 運用要件定義書で確定 |
| 監査ログ | 未確定 | 法規制・監査要件に従う |
| 業務ログ | 未確定 | 業務要件に従う |

### 9.2 保護方針

**表13 — 保護方針**
| 項目 | 方針 |
|-----|------|
| アクセス制御 | ロールに基づいたアクセス制御を実施しなければならない |
| 改ざん防止 | WORM または署名による改ざん検知を検討することが望ましい |
| 暗号化 | 保管時暗号化を実施しなければならない |

---

## 第10章 分散トレーシング方針

**表14 — 分散トレーシング方針**
| 項目 | 方針 |
|-----|------|
| トレースID伝播 | すべてのサービス間通信でトレースIDを伝播しなければならない |
| サンプリング | 本番環境ではサンプリング率を設定してもよい |
| 可視化 | トレース情報を可視化するツールを導入することが望ましい |
