---
id: EXPZZZZ001
title: 例外処理ポリシー
sidebar_position: 1
---

# 例外処理ポリシー

| 項目 | 内容 |
|------|------|
| ドキュメントID | EXPZZZZ001 |
| 版数 | 1.0 |
| 作成日 | 2026-01-14 |
| 最終更新日 | 2026-01-14 |
| ステータス | ドラフト |

---

## 第1章 適用範囲

### 1.1 目的

本ポリシーは、クリーンアーキテクチャに基づき、ハウスクレジット基幹システム横断で統一された例外処理の基準を定義するものとする。

本書は **例外発生条件の定義ではなく、例外をどのように扱うかの枠組み** を定義する。

本書はBC固有仕様には依存しない。

非機能要件・運用監視・アラート設計・セキュリティ方針は参照のみとし、本書の責務外とする。

### 1.2 適用範囲

**表1 — 適用範囲**

| 項目 | 記述内容 |
|------|----------|
| 対象システム | ハウスクレジット基幹システム |
| 対象BC | ドメインスコープ定義書およびコンテキストマップに定義された全BC |
| 対象レイヤ | Entity／UseCase／Adapter／Frameworkの全レイヤ |
| 除外対象 | 非機能要件・運用監視・アラート設計・セキュリティ方針（参照のみ） |

### 1.3 関連文書

**表2 — 関連文書一覧**

| 関連ドキュメント | 関係性 |
|------------------|--------|
| ソフトウェアアーキテクチャ方針書 | クリーンアーキテクチャの詳細を参照 |
| アプリケーションログ方針書 | ログ出力方針を参照 |
| トランザクション方針書 | トランザクション境界・ロールバック方針を参照 |
| セキュリティ方針書 | PIIマスキング等を参照 |
| 非同期連携方針書 | DLQ・再送制御の詳細を参照 |

---

## 第2章 引用規格

本書は以下の規格・標準を参照する：

- ISO/IEC 25010:2011 システム及びソフトウェア品質モデル
- クリーンアーキテクチャ（Robert C. Martin）
- エンタープライズアプリケーションアーキテクチャパターン（Martin Fowler）

---

## 第3章 用語及び定義

本書で使用する主要な用語を以下に定義する。

**表3 — 用語定義**

| 用語 | 定義 |
|------|------|
| ドメイン例外 | ビジネスルール違反に起因する例外（エンティティ層で発生） |
| アプリケーション例外 | ユースケース前提条件違反・制御フロー上の失敗 |
| インフラ例外 | DB/ネットワーク/外部APIなど技術的エラー |
| システム例外 | ランタイム／OSレベルの異常 |
| 補償トランザクション | 分散システムでエラー発生時に実行する取り消し処理 |
| DLQ | Dead Letter Queue。処理失敗メッセージの退避先キュー |
| サーキットブレーカー | 連続失敗時に一時的に処理を停止する仕組み |
| フォールバック | エラー発生時の代替処理 |

---

## 第4章 例外分類ポリシー

### 4.1 例外の基本分類

例外は以下に分類しなければならない。

**表4 — 例外分類**

| 区分 | 説明 | 発生層 | 再試行可否 | 回復可否 |
|------|------|--------|-----------|---------|
| ドメイン例外 | ビジネスルール違反（不変条件違反） | Entity | 不可 | ビジネス判断による |
| アプリケーション例外 | ユースケース前提条件違反／制御フロー上の失敗 | UseCase | 不可 | ビジネス判断による |
| インフラ例外 | DB/ネットワーク/外部APIなど技術的エラー | Adapter/Infrastructure | 条件付き可 | 可 |
| システム例外 | ランタイム／OSレベルの異常 | すべての層 | 不可 | 不可 |

### 4.2 クライアントへの例外返却方針

**表5 — クライアントへの例外返却方針**

| 区分 | クライアントへの返却 | 詳細情報 | HTTPステータス例 |
|------|---------------------|---------|-----------------|
| ドメイン例外 | 返却する | ビジネスエラーコード・メッセージを返却 | 422 Unprocessable Entity |
| アプリケーション例外 | 返却する | ユースケース失敗理由を返却 | 400 Bad Request / 409 Conflict |
| インフラ例外 | 隠蔽する | 汎用エラーに変換して返却 | 503 Service Unavailable |
| システム例外 | 隠蔽する | 汎用エラーに変換して返却 | 500 Internal Server Error |

---

## 第5章 レイヤ別例外ハンドリング責務

### 5.1 エンティティ層（Domain Layer）

#### 5.1.1 基本方針

ビジネスルール違反時はDomainExceptionを発火しなければならない。

**表6 — エンティティ層例外設計**

| 項目 | 方針 |
|------|------|
| 発火条件 | ビジネスルール（不変条件）違反時 |
| 例外クラス | DomainException |
| 付与情報 | rule-id, message, parameters |
| ログ出力 | エンティティ層ではログを出力してはならない |
| 外部依存 | エンティティ層からインフラ層の例外を投げてはならない |

#### 5.1.2 実装例

ドメイン例外は以下の情報を持たなければならない：

- **rule-id**: ビジネスルールの識別子
- **message**: ユーザー向けメッセージ
- **parameters**: エラーに関連するパラメータ

### 5.2 ユースケース層（Application Layer）

#### 5.2.1 基本方針

DomainExceptionを捕捉しApplicationExceptionに変換しなければならない。トランザクション境界とロールバック判断を行わなければならない。

**表7 — ユースケース層例外設計**

| 項目 | 方針 |
|------|------|
| DomainException | 捕捉してApplicationExceptionに変換しなければならない |
| InfrastructureException | 捕捉してリトライ判断またはロールバックを行わなければならない |
| トランザクション境界 | ユースケース層を境界としなければならない |
| ログ出力 | 業務失敗はINFO/WARNレベルで出力することが望ましい |
| 例外変換 | 下位層の例外を上位層の抽象度に合わせて変換しなければならない |

#### 5.2.2 トランザクション制御

**表8 — トランザクション制御方針**

| 例外種別 | ロールバック | コミット |
|---------|------------|---------|
| DomainException | ビジネス判断による | ビジネス判断による |
| ApplicationException | ビジネス判断による | ビジネス判断による |
| InfrastructureException | 必須 | 不可 |
| SystemException | 必須 | 不可 |

### 5.3 アダプタ層（Interface Adapters Layer）

#### 5.3.1 基本方針

ApplicationException → APIレスポンスへ変換しなければならない。バリデーションエラーとの整合も定義しなければならない。

**表9 — アダプタ層例外設計**

| 項目 | 方針 |
|------|------|
| ApplicationException | HTTPレスポンスのエラーコード・メッセージに変換しなければならない |
| バリデーションエラー | 400系レスポンスとして返却しなければならない |
| ログ出力 | 入口／出口ログを出力しなければならない |
| PIIマスキング | エラーレスポンス・ログに機微情報を含めてはならない |
| 例外隠蔽 | インフラ例外・システム例外の詳細を外部に公開してはならない |

---

## 第6章 例外クラス設計指針

### 6.1 例外クラス階層

**表10 — 例外クラス設計**

| クラス名 | 用途 | 必須属性 | 配置層 |
|---------|------|---------|--------|
| DomainException | ビジネスルール違反 | rule-id, message, parameters | Domain |
| ApplicationException | ユースケース失敗 | errorCode, userMessage, cause | Application |
| InfrastructureException | 外部API／DB／ネットワーク抽象化 | systemName, originalError, retryable | Infrastructure |
| SystemException | ランタイム異常 | errorCode, stackTrace | すべての層 |

### 6.2 ラップ例外・再スローの原則

**表11 — ラップ例外・再スローの原則**

| 原則 | 説明 |
|------|------|
| 原因チェーン | 例外をラップする場合、原因（cause）を必ず保持しなければならない |
| 再スロー条件 | 上位レイヤで処理すべき例外のみ再スローしなければならない |
| 情報損失禁止 | 例外変換時に元の情報を失ってはならない |
| 抽象度維持 | 各層の抽象度に合った例外クラスを使用しなければならない |
| スタックトレース保持 | 元の例外のスタックトレースを保持しなければならない |

### 6.3 チェック例外 vs 非チェック例外

**表12 — チェック例外・非チェック例外の使い分け**

| 種別 | 使用場面 | 例 |
|------|---------|-----|
| チェック例外 | 回復可能なビジネス例外 | DomainException, ApplicationException |
| 非チェック例外 | プログラミングエラー・システム異常 | NullPointerException, SystemException |

**注記：** 言語仕様により使い分けが異なる場合は、プロジェクト標準に従うこと。

---

## 第7章 例外発生時のハンドリング方針

### 7.1 トランザクション境界

トランザクション方針書と整合を取る必要がある。

**表13 — トランザクション境界方針**

| 項目 | 方針 |
|------|------|
| 境界定義 | ユースケース層をトランザクション境界としなければならない |
| ロールバック基準 | インフラ例外・システム例外は原則ロールバックしなければならない |
| コミット条件 | ドメイン例外・アプリケーション例外はビジネス判断に従う |
| トランザクションタイムアウト | タイムアウト時は確実にロールバックしなければならない |

### 7.2 リトライポリシー

**表14 — リトライポリシー**

| 項目 | 方針 |
|------|------|
| 対象例外 | 原則インフラ例外のみリトライ対象としなければならない |
| リトライ回数 | 最大3回を基本とする（具体値は非機能要件定義書を参照） |
| バックオフ | Exponential Backoffを採用することが望ましい |
| 冪等性 | リトライ対象の処理は冪等でなければならない |
| リトライ判定 | InfrastructureExceptionのretryableフラグで判定しなければならない |

### 7.3 デグレード戦略

システムの一部障害時でも可能な限りサービスを継続するための戦略を定める。

**表15 — デグレード戦略**

| 項目 | 方針 |
|------|------|
| 部分機能停止 | 障害発生コンポーネントのみ停止し、他機能は継続することが望ましい |
| フォールバック | キャッシュ利用・代替処理を検討することが望ましい |
| サーキットブレーカー | 連続失敗時は一時的に呼び出しを停止することが望ましい |
| グレースフルデグレード | 機能制限モードでサービスを継続することが望ましい |

### 7.4 サーキットブレーカーパターン

**表16 — サーキットブレーカー方針**

| 状態 | 説明 | 動作 |
|------|------|------|
| Closed | 正常状態 | すべてのリクエストを通す |
| Open | 障害検出状態 | すべてのリクエストを即座に失敗させる |
| Half-Open | 復旧確認状態 | 限定的にリクエストを通し、復旧を確認 |

---

## 第8章 ロギング・監査・PIIマスキング方針

### 8.1 レイヤ別ログ出力方針

**表17 — レイヤ別ログ出力方針**

| レイヤ | ログ出力方針 | ログレベル |
|--------|-------------|-----------|
| エンティティ層 | ログを書いてはならない | - |
| ユースケース層 | 業務失敗はINFO/WARNで出力することが望ましい | INFO/WARN |
| アダプタ層 | 入口／出口ログを出力しなければならない | INFO/ERROR |
| 外部FW層 | ERROR/FATALを出力しなければならない | ERROR/FATAL |

### 8.2 例外ログ出力内容

**表18 — 例外ログ出力内容**

| 項目 | 出力可否 | 注意事項 |
|------|---------|---------|
| 例外クラス名 | 必須 | - |
| エラーメッセージ | 必須 | PIIマスキング適用 |
| スタックトレース | 必須（ERROR以上） | 本番環境では詳細度を制限することが望ましい |
| エラーコード | 必須 | - |
| トレースID | 必須 | 分散トレーシング用 |
| ユーザーID | 推奨 | 監査目的、PIIマスキング考慮 |
| タイムスタンプ | 必須 | - |

### 8.3 PIIマスキング方針

個人情報保護の観点から、ログおよびエラーレスポンスに機微情報を含めてはならない。

**表19 — PIIマスキング方針**

| 項目 | 方針 |
|------|------|
| 対象データ | 個人情報・決済情報・認証情報・パスワード |
| マスキング方式 | 部分マスク（例：\*\*\*\*1234）または完全除去 |
| 適用箇所 | ログ、エラーレスポンス、監査証跡、スタックトレース |
| 実装方法 | ロギングフレームワークのマスキング機能を使用しなければならない |

**注記：** 詳細は「セキュリティ方針書」および「アプリケーションログ方針書」を参照すること。

---

## 第9章 外部サービス連携例外の扱い

### 9.1 外部API呼び出し例外

**表20 — 外部サービス連携例外方針**

| 項目 | 方針 |
|------|------|
| タイムアウト | 標準30秒、上限60秒（具体値は非機能要件定義書を参照、未確定） |
| リトライ回数 | 最大3回（Exponential Backoff） |
| デグレード戦略 | キャッシュ利用・部分停止を検討する |
| 例外変換 | 外部APIエラー → InfrastructureException → ApplicationException |
| サーキットブレーカー | 連続失敗時は一時的に呼び出しを停止することが望ましい |

### 9.2 外部システムエラー分類

**表21 — 外部システムエラー分類**

| エラー種別 | HTTPステータス例 | リトライ | 対応 |
|-----------|-----------------|---------|------|
| 一時的エラー | 503, 504 | 可 | リトライ後に失敗した場合はフォールバック |
| クライアントエラー | 400, 401, 403, 404 | 不可 | ApplicationExceptionに変換して返却 |
| サーバーエラー | 500, 502 | 可 | リトライ、サーキットブレーカー |
| タイムアウト | - | 可 | リトライ、タイムアウト値の見直し |

---

## 第10章 APIエラーレスポンス変換規則

### 10.1 HTTPステータスコード対応

**表22 — HTTPステータスコード対応**

| 例外区分 | HTTPステータス | 説明 | エラーコード例 |
|---------|---------------|------|---------------|
| バリデーションエラー | 400 Bad Request | 入力形式エラー | VAL_001 |
| ドメイン例外 | 422 Unprocessable Entity | ビジネスルール違反 | BIZ_001 |
| 認証エラー | 401 Unauthorized | 認証失敗 | AUTH_001 |
| 認可エラー | 403 Forbidden | 権限不足 | AUTHZ_001 |
| リソース未存在 | 404 Not Found | リソースが見つからない | RES_001 |
| 競合エラー | 409 Conflict | リソース競合（楽観ロック失敗等） | CONF_001 |
| インフラ例外 | 503 Service Unavailable | 外部サービス障害 | SYS_003 |
| システム例外 | 500 Internal Server Error | 予期しないエラー | SYS_001 |

### 10.2 エラーレスポンスフォーマット

エラーレスポンスは以下の構造を持たなければならない。

**表23 — エラーレスポンス構造**

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| errorCode | string | 必須 | エラーコード（例：BIZ_001） |
| message | string | 必須 | ユーザー向けメッセージ |
| details | array | 任意 | 詳細情報（バリデーションエラー詳細等） |
| traceId | string | 必須 | トレースID（分散トレーシング用） |
| timestamp | string | 必須 | 発生日時（ISO 8601形式） |
| path | string | 任意 | リクエストパス |

### 10.3 エラーコード体系

**表24 — エラーコード体系**

| プレフィックス | カテゴリ | 例 |
|--------------|---------|-----|
| VAL_ | バリデーションエラー | VAL_001: 必須項目未入力 |
| BIZ_ | ビジネスルール違反 | BIZ_001: 与信枠超過 |
| AUTH_ | 認証エラー | AUTH_001: 認証失敗 |
| AUTHZ_ | 認可エラー | AUTHZ_001: 権限不足 |
| RES_ | リソースエラー | RES_001: リソース未存在 |
| CONF_ | 競合エラー | CONF_001: 楽観ロック失敗 |
| SYS_ | システムエラー | SYS_001: 予期しないエラー |

---

## 第11章 バッチ／非同期処理における例外方針

### 11.1 バッチ処理戻りコード

**表25 — バッチ処理戻りコード**

| 戻りコード | 意味 | 説明 |
|-----------|------|------|
| 0 | 正常終了 | すべての処理が正常に完了 |
| 1 | 警告終了 | 一部のレコードをスキップしたが処理は継続 |
| 2 | 異常終了（リトライ可） | 一時的なエラーによる失敗 |
| 9 | 異常終了（リトライ不可） | 恒久的なエラーによる失敗 |

### 11.2 非同期処理例外方針

**表26 — 非同期処理例外方針**

| 項目 | 方針 |
|------|------|
| リトライ | 最大3回まで再試行しなければならない |
| DLQ | リトライ上限超過時はDLQに退避しなければならない |
| 監視 | DLQ滞留を監視し、アラートを発報しなければならない |
| 冪等性 | 非同期処理は冪等でなければならない |
| ログ記録 | すべてのリトライ・DLQ退避をログに記録しなければならない |

### 11.3 メッセージ処理エラーハンドリング

**表27 — メッセージ処理エラーハンドリング**

| エラー種別 | 対応 |
|-----------|------|
| デシリアライズエラー | DLQに即座に退避 |
| ビジネスルール違反 | ログ記録後、DLQに退避 |
| 一時的なインフラエラー | リトライ（最大3回） |
| 恒久的なエラー | ログ記録後、DLQに退避 |

---

## 第12章 設計・実装パターン

### 12.1 推奨パターン

**表28 — 設計・実装パターン**

| パターン | 採用方針 | 備考 |
|---------|---------|------|
| Result型／Either型 | 採用を検討してもよい | 言語・FWに依存（Kotlin、Rust等で有効） |
| 例外階層設計 | Domain/Application/Infrastructureの3階層を採用しなければならない | - |
| GlobalExceptionHandler | REST APIではGlobalExceptionHandlerを実装しなければならない | Spring等のFW機能を活用 |
| ArchUnit / ArchTest | レイヤ依存方向を強制することが望ましい | アーキテクチャテスト |

### 12.2 アンチパターン

以下のアンチパターンは避けなければならない。

**表29 — アンチパターン**

| アンチパターン | 説明 | 対策 |
|--------------|------|------|
| 空のcatchブロック | 例外を無視する | 適切なログ出力・再スロー |
| 汎用例外の乱用 | Exceptionクラスを直接使用 | 適切な例外クラスを定義 |
| 例外の握りつぶし | 例外を捕捉するが適切に処理しない | 上位層に伝播または適切に処理 |
| スタックトレースの損失 | 例外を再作成してスタックトレースを失う | causeを適切に設定 |
| 制御フローとしての例外 | 正常系の制御に例外を使用 | 戻り値やResult型を使用 |

---

## 第13章 運用・監視方針（参照）

本書では障害検知・アラート閾値・運用フローは扱わない。詳細は以下を参照すること：

- 非機能要件定義書
- 運用設計書
- アプリケーションログ方針書

### 13.1 監視対象例外

**表30 — 監視対象例外（参照）**

| 監視項目 | 閾値例 | アラート |
|---------|--------|---------|
| システム例外発生率 | 1%超過 | Critical |
| インフラ例外発生率 | 5%超過 | Warning |
| DLQ滞留件数 | 10件超過 | Warning |
| サーキットブレーカーOpen | 1回 | Warning |

**注記：** 具体的な閾値は非機能要件定義書で定める。

---

## 付録A 未確定事項一覧

本ポリシーにおいて「未確定」と記載された事項を以下にまとめる。これらは後続の検討・合意形成により確定させなければならない。

**表A.1 — 未確定事項一覧**

| 章節 | 項目 | 備考 |
|------|------|------|
| 9.1 | 外部APIタイムアウトの具体値 | 非機能要件定義書での定義が必要 |
| 13.1 | 監視アラート閾値の具体値 | 非機能要件定義書での定義が必要 |

---

## 付録B 検討が必要な論点

以下は、本ポリシーの運用にあたり検討が必要な論点である。

1. **Result型・Either型の採用**
   - 言語・フレームワークの特性に応じた採用可否
   - 例外とResult型の使い分け基準
   - 学習コストとメリットのトレードオフ

2. **エラーコード体系の詳細設計**
   - BC単位でのエラーコード範囲割り当て
   - エラーコード一覧の管理方法
   - 多言語対応時のメッセージ管理

3. **分散トレーシングの実装**
   - トレースIDの生成・伝播方法
   - トレーシングツールの選定（Jaeger、Zipkin等）
   - マイクロサービス間のトレース連携

4. **サーキットブレーカーの実装**
   - 採用ライブラリの選定（Resilience4j、Hystrix等）
   - 閾値・タイムアウト設定
   - モニタリング・アラート設計

5. **例外とログの関係**
   - 同じ例外を複数箇所でログ出力しない制御
   - ログ出力レベルの統一基準
   - 構造化ログとの連携

6. **テスト戦略**
   - 例外ハンドリングのテスト方法
   - エラーレスポンスの自動検証
