あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】に基づいて、対象システムの「例外処理ポリシー」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。

---

### **【形式】**

`第〇章：##`\
`〇.〇：###`\
`小見出し：####`\
その他：通常テキスト\
表はMarkdown表形式で記載\
JSON / CSV形式は禁止

---

# **例外処理ポリシー**

---

## 第1章：目的

本ポリシーは、クリーンアーキテクチャに基づき、システム横断で統一された例外処理の基準を定義するものとする。\
本書は **例外発生条件の定義ではなく、例外をどのように扱うかの枠組み** を定義する。\
本書は BC 固有仕様には依存しない。\
非機能要件・運用監視・アラート設計・セキュリティ方針は参照のみとし、本書の責務外とする。

---

## 第2章：入力情報と前提

### 2.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 2.2 前提条件

* クリーンアーキテクチャを前提とし、Entity／UseCase／Adapter／Framework の各層責務が分離されている：未確定
* エラー管理の共通ルール（ログ、監査、PIIマスキングなど）は別資料にて定義される：未確定
* 外部API・DBなどの技術例外は InfrastructureException に正規化する方針を採用する：未確定
* APIレスポンス変換規約（例：共通エラーコード体系）は別途定義されている：未確定
* 非同期処理（バッチ／キュー）は外部方針書に従う：未確定

---

## 第3章：例外分類ポリシー

例外は以下に分類する。
| 区分 | 説明 |
|----|----|
| ドメイン例外 | ビジネスルール違反（エンティティ層） |
| アプリケーション例外 | ユースケース前提条件違反／制御フロー上の失敗 |
| インフラ例外 | DB/ネットワーク/外部APIなど技術的エラー |
| システム例外 | ランタイム／OSレベルの異常 |

再試行可能／不可、回復可能／不可の基準を含める。\
クライアントへ返却すべき例外／隠蔽すべき例外の境界を定義する。

---

## 第4章：レイヤ別例外ハンドリング責務

### ● エンティティ層

ビジネスルール違反時は DomainException を発火する。\
付与可能情報：rule-id, message, parameters。

### ● ユースケース層

DomainException を捕捉し ApplicationException に変換する。\
トランザクション境界とロールバック判断を行う。

### ● アダプタ層

ApplicationException → APIレスポンスへ変換。\
バリデーションエラーとの整合も定義する。

---

## 第5章：例外クラス設計指針

* DomainException：rule-id, message, parameters
* ApplicationException：ユースケース失敗理由、ユーザ向けコード表現
* InfrastructureException：外部API／DB／ネットワークの抽象化
* SystemException：ランタイム異常

ラップ例外・再スローの原則を明示する。

---

## 第6章：例外発生時のハンドリング方針

* トランザクション境界：ユースケース層を境界とする。
* ロールバック基準：インフラ例外・システム例外は原則ロールバック。
* リトライポリシー：原則インフラ例外のみ対象。
* デグレード戦略：部分機能停止、代替処理等。

---

## 第7章：ロギング・監査・PIIマスキング方針

* エンティティ層はログを書かない。
* ユースケース層：業務失敗は INFO/WARN
* アダプタ層：入口／出口ログ
* 外部FW層：ERROR/FATAL
* PII マスキング規約を明示する。

（※監査ログ方針は別ドキュメントを参照）

---

## 第8章：外部サービス連携例外の扱い

* タイムアウト標準値・上限
* リトライ回数／Backoff
* デグレード戦略（キャッシュ利用・部分停止）
* 外部APIエラー → InfrastructureException → ApplicationException

---

## 第9章：APIエラーレスポンス変換規則

* 共通エラーコード体系
* ユーザ向け表記ルール（ユビキタス言語準拠）
* HTTP ステータス対応表
* REST / GraphQL のエラーレスポンス形式

---

## 第10章：構造化例外情報フォーマット（JSON構造）

```auto
{
  "errorCode": "string",
  "message": "string",
  "details": {},
  "traceId": "string"
}
```

---

## 第11章：バッチ／非同期処理における戻りコード・例外方針

* 戻りコード規定
* 非同期キュー処理での例外扱い
* 再実行／DLQ（Dead Letter Queue）方針

---

## 第12章：設計・実装パターン

* Result 型／Either 型の採用可否
* Domain/Application/Infrastructure Exception の境界
* ArchUnit / ArchTest によるレイヤ依存方向の強制

---

## 第13章：運用・監視方針（参照）

本書では 障害検知・アラート閾値・運用フローは扱わない\
参照：非機能要件定義書、運用設計書