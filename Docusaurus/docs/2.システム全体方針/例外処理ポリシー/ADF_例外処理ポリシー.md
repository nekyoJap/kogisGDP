あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】および【ISO/IEC Directives Part 2準拠ルール】に基づいて、対象システムの「例外処理ポリシー」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。

---

### 【形式】

章：`## 第1章 タイトル`\
節：`### 1.1 タイトル`\
項：`#### 1.1.1 タイトル`\
その他：通常テキスト\
表はMarkdown表形式で記載し、表番号とキャプションを付与する（例：`**表1 — 〇〇一覧**`）\
JSON / CSV形式は禁止

---

### 【ISO/IEC Directives Part 2準拠ルール】

#### 要求事項の表現
出力文書では以下の表現を使い分けること：

| 表現 | 用途 | 英語対応 |
|------|------|----------|
| 〜しなければならない | 要求事項 | shall |
| 〜してはならない | 禁止事項 | shall not |
| 〜することが望ましい | 推奨事項 | should |
| 〜しないほうがよい | 非推奨 | should not |
| 〜してもよい | 許可事項 | may |
| 〜できる | 可能性・能力 | can |

#### 文書構成の原則
- 要求事項と説明・解説を明確に区別すること
- 各章・節には目的を明示すること
- 表には連番とキャプションを付与すること

---

## 第1章 適用範囲

### 1.1 目的

本ポリシーは、クリーンアーキテクチャに基づき、システム横断で統一された例外処理の基準を定義するものとする。\
本書は **例外発生条件の定義ではなく、例外をどのように扱うかの枠組み** を定義する。\
本書は BC 固有仕様には依存しない。\
非機能要件・運用監視・アラート設計・セキュリティ方針は参照のみとし、本書の責務外とする。

### 1.2 適用範囲

**表1 — 適用範囲**
| 項目 | 記述内容 |
|----|------|
| 対象システム | ハウスクレジット基幹システム |
| 対象BC | ドメインスコープ定義書およびコンテキストマップに定義された全BC |
| 対象レイヤ | Entity／UseCase／Adapter／Framework の全レイヤ |
| 除外対象 | 非機能要件・運用監視・アラート設計・セキュリティ方針（参照のみ） |

### 1.3 関連文書

**表2 — 関連文書一覧**
| 関連ドキュメント | 関係性 |
|----------------|--------|
| ソフトウェアアーキテクチャ方針書 | クリーンアーキテクチャの詳細を参照 |
| アプリケーションログ方針書 | ログ出力方針を参照 |
| トランザクション方針書 | トランザクション境界・ロールバック方針を参照 |
| セキュリティ方針書 | PII マスキング等を参照 |
| 非同期連携方針書 | DLQ・再送制御の詳細を参照 |

---

## 第2章 引用規格

本書は以下の規格・標準を参照する：

- ISO/IEC 25010:2011 システム及びソフトウェア品質モデル
- クリーンアーキテクチャ（Robert C. Martin）

---

## 第3章 用語及び定義

本書で使用する主要な用語を以下に定義する：

**表3 — 用語定義**
| 用語 | 定義 |
|------|------|
| ドメイン例外 | ビジネスルール違反に起因する例外（エンティティ層で発生） |
| アプリケーション例外 | ユースケース前提条件違反・制御フロー上の失敗 |
| インフラ例外 | DB/ネットワーク/外部APIなど技術的エラー |
| システム例外 | ランタイム／OSレベルの異常 |
| 補償トランザクション | 分散システムでエラー発生時に実行する取り消し処理 |
| DLQ | Dead Letter Queue。処理失敗メッセージの退避先キュー |

---

## 第4章 入力情報と前提

### 4.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 4.2 前提条件

* クリーンアーキテクチャを前提とし、Entity／UseCase／Adapter／Framework の各層責務が分離されている：未確定
* エラー管理の共通ルール（ログ、監査、PIIマスキングなど）は別資料にて定義される：未確定
* 外部API・DBなどの技術例外は InfrastructureException に正規化する方針を採用する：未確定
* APIレスポンス変換規約（例：共通エラーコード体系）は別途定義されている：未確定
* 非同期処理（バッチ／キュー）は外部方針書に従う：未確定

---

## 第5章 例外分類ポリシー

例外は以下に分類しなければならない。

**表4 — 例外分類**
| 区分 | 説明 | 再試行可否 | 回復可否 |
|----|----|----------|--------|
| ドメイン例外 | ビジネスルール違反（エンティティ層） | 不可 | ビジネス判断による |
| アプリケーション例外 | ユースケース前提条件違反／制御フロー上の失敗 | 不可 | ビジネス判断による |
| インフラ例外 | DB/ネットワーク/外部APIなど技術的エラー | 条件付き可 | 可 |
| システム例外 | ランタイム／OSレベルの異常 | 不可 | 不可 |

**表5 — クライアントへの例外返却方針**
| 区分 | クライアントへの返却 | 詳細情報 |
|----|--------------------|---------|
| ドメイン例外 | 返却する | ビジネスエラーコード・メッセージを返却 |
| アプリケーション例外 | 返却する | ユースケース失敗理由を返却 |
| インフラ例外 | 隠蔽する | 汎用エラーに変換して返却 |
| システム例外 | 隠蔽する | 汎用エラーに変換して返却 |

---

## 第6章 レイヤ別例外ハンドリング責務

### 6.1 エンティティ層

ビジネスルール違反時は DomainException を発火しなければならない。\
付与情報：rule-id, message, parameters。

**表6 — エンティティ層例外設計**
| 項目 | 方針 |
|----|----|
| 発火条件 | ビジネスルール（不変条件）違反時 |
| 例外クラス | DomainException |
| 付与情報 | rule-id, message, parameters |
| ログ出力 | エンティティ層ではログを出力してはならない |

### 6.2 ユースケース層

DomainException を捕捉し ApplicationException に変換しなければならない。\
トランザクション境界とロールバック判断を行わなければならない。

**表7 — ユースケース層例外設計**
| 項目 | 方針 |
|----|----|
| DomainException | 捕捉して ApplicationException に変換しなければならない |
| InfrastructureException | 捕捉してリトライ判断またはロールバックを行わなければならない |
| トランザクション境界 | ユースケース層を境界としなければならない |
| ログ出力 | 業務失敗は INFO/WARN レベルで出力することが望ましい |

### 6.3 アダプタ層

ApplicationException → APIレスポンスへ変換しなければならない。\
バリデーションエラーとの整合も定義しなければならない。

**表8 — アダプタ層例外設計**
| 項目 | 方針 |
|----|----|
| ApplicationException | HTTPレスポンスのエラーコード・メッセージに変換しなければならない |
| バリデーションエラー | 400系レスポンスとして返却しなければならない |
| ログ出力 | 入口／出口ログを出力しなければならない |
| PII マスキング | エラーレスポンス・ログに機微情報を含めてはならない |

---

## 第7章 例外クラス設計指針

**表9 — 例外クラス設計**
| クラス名 | 用途 | 必須属性 |
|---------|------|----------|
| DomainException | ビジネスルール違反 | rule-id, message, parameters |
| ApplicationException | ユースケース失敗 | errorCode, userMessage, cause |
| InfrastructureException | 外部API／DB／ネットワーク抽象化 | systemName, originalError, retryable |
| SystemException | ランタイム異常 | errorCode, stackTrace |

### 7.1 ラップ例外・再スローの原則

**表10 — ラップ例外・再スローの原則**
| 原則 | 説明 |
|------|------|
| 原因チェーン | 例外をラップする場合、原因（cause）を必ず保持しなければならない |
| 再スロー条件 | 上位レイヤで処理すべき例外のみ再スローしなければならない |
| 情報損失禁止 | 例外変換時に元の情報を失ってはならない |

---

## 第8章 例外発生時のハンドリング方針

### 8.1 トランザクション境界

**表11 — トランザクション境界方針**
| 項目 | 方針 |
|----|----|
| 境界定義 | ユースケース層をトランザクション境界としなければならない |
| ロールバック基準 | インフラ例外・システム例外は原則ロールバックしなければならない |
| コミット条件 | ドメイン例外・アプリケーション例外は業務判断に従う |

### 8.2 リトライポリシー

**表12 — リトライポリシー**
| 項目 | 方針 |
|----|----|
| 対象例外 | 原則インフラ例外のみリトライ対象としなければならない |
| リトライ回数 | 最大3回を基本とする（具体値は非機能要件定義書を参照） |
| バックオフ | Exponential Backoff を採用することが望ましい |

### 8.3 デグレード戦略

**表13 — デグレード戦略**
| 項目 | 方針 |
|----|----|
| 部分機能停止 | 障害発生コンポーネントのみ停止し、他機能は継続することが望ましい |
| フォールバック | キャッシュ利用・代替処理を検討することが望ましい |
| サーキットブレーカー | 連続失敗時は一時的に呼び出しを停止することが望ましい |

---

## 第9章 ロギング・監査・PIIマスキング方針

**表14 — レイヤ別ログ出力方針**
| レイヤ | ログ出力方針 |
|------|-------------|
| エンティティ層 | ログを書いてはならない |
| ユースケース層 | 業務失敗は INFO/WARN で出力することが望ましい |
| アダプタ層 | 入口／出口ログを出力しなければならない |
| 外部FW層 | ERROR/FATAL を出力しなければならない |

**表15 — PIIマスキング方針**
| 項目 | 方針 |
|----|----|
| 対象データ | 個人情報・決済情報・認証情報 |
| マスキング方式 | 部分マスク（例：****1234）または完全除去 |
| 適用箇所 | ログ、エラーレスポンス、監査証跡 |

注：監査ログ方針の詳細は「アプリケーションログ方針書」を参照すること。

---

## 第10章 外部サービス連携例外の扱い

**表16 — 外部サービス連携例外方針**
| 項目 | 方針 |
|----|----|
| タイムアウト | 標準30秒、上限60秒（具体値は非機能要件定義書を参照） |
| リトライ回数 | 最大3回（Exponential Backoff） |
| デグレード戦略 | キャッシュ利用・部分停止を検討する |
| 例外変換 | 外部APIエラー → InfrastructureException → ApplicationException |

---

## 第11章 APIエラーレスポンス変換規則

**表17 — HTTPステータスコード対応**
| 例外区分 | HTTPステータス | 説明 |
|---------|---------------|------|
| バリデーションエラー | 400 Bad Request | 入力形式エラー |
| ドメイン例外 | 422 Unprocessable Entity | ビジネスルール違反 |
| 認証エラー | 401 Unauthorized | 認証失敗 |
| 認可エラー | 403 Forbidden | 権限不足 |
| インフラ例外 | 503 Service Unavailable | 外部サービス障害 |
| システム例外 | 500 Internal Server Error | 予期しないエラー |

---

## 第12章 構造化例外情報フォーマット

エラーレスポンスは以下の構造を持たなければならない：

```
errorCode: エラーコード（必須）
message: ユーザー向けメッセージ（必須）
details: 詳細情報（任意）
traceId: トレースID（必須）
timestamp: 発生日時（必須）
```

---

## 第13章 バッチ／非同期処理における戻りコード・例外方針

**表18 — バッチ処理戻りコード**
| 戻りコード | 意味 |
|-----------|------|
| 0 | 正常終了 |
| 1 | 警告終了（一部スキップ） |
| 2 | 異常終了（リトライ可） |
| 9 | 異常終了（リトライ不可） |

**表19 — 非同期処理例外方針**
| 項目 | 方針 |
|----|----|
| リトライ | 最大3回まで再試行しなければならない |
| DLQ | リトライ上限超過時はDLQに退避しなければならない |
| 監視 | DLQ滞留を監視し、アラートを発報しなければならない |

---

## 第14章 設計・実装パターン

**表20 — 設計・実装パターン**
| パターン | 採用方針 |
|---------|---------|
| Result型／Either型 | 採用を検討してもよい（言語・FWに依存） |
| 例外階層設計 | Domain/Application/Infrastructure の3階層を採用しなければならない |
| ArchUnit / ArchTest | レイヤ依存方向を強制することが望ましい |

---

## 第15章 運用・監視方針（参照）

本書では障害検知・アラート閾値・運用フローは扱わない。\
詳細は以下を参照すること：

* 非機能要件定義書
* 運用設計書