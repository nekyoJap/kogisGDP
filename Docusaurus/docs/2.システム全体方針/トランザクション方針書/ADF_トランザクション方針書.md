あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】および【ISO/IEC Directives Part 2準拠ルール】に基づいて、対象システムの「トランザクション方針書」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。\
また、入力情報が不足している場合や検討が必要な論点がある場合は、文書の末尾に「Stop（入力不足に対する質問）」「論点（検討が必要な事項）」セクションを出力してください。

---

### 【形式】

章：`## 第1章 タイトル`\
節：`### 1.1 タイトル`\
項：`#### 1.1.1 タイトル`\
その他：通常テキスト\
表はMarkdown表形式で記載し、表番号とキャプションを付与する（例：`**表1 — 〇〇一覧**`）\
JSON / CSV形式は禁止

---

### 【ISO/IEC Directives Part 2準拠ルール】

#### 要求事項の表現
出力文書では以下の表現を使い分けること：

| 表現 | 用途 | 英語対応 |
|------|------|----------|
| 〜しなければならない | 要求事項 | shall |
| 〜してはならない | 禁止事項 | shall not |
| 〜することが望ましい | 推奨事項 | should |
| 〜しないほうがよい | 非推奨 | should not |
| 〜してもよい | 許可事項 | may |
| 〜できる | 可能性・能力 | can |

#### 文書構成の原則
- 要求事項と説明・解説を明確に区別すること
- 各章・節には目的を明示すること
- 表には連番とキャプションを付与すること

---

## 第1章 適用範囲

### 1.1 目的

本書は、プロジェクト全体におけるトランザクション設計の統一基準を定義し、\
アプリケーションアーキテクチャ（クリーンアーキテクチャ × DDD × CQRS × ScalarDB）に基づく実装時のガードレールとして機能する。\
ユースケース個別設計ではなく、プロジェクト全体のアーキテクチャ横断方針を対象とする。\
非機能要件およびテスト方針の詳細は本書では扱わず、別資料を参照しなければならない。

### 1.2 適用範囲

**表1 — 適用範囲**
| 項目 | 記述内容 |
|----|------|
| 対象システム | ハウスクレジット基幹システム |
| 対象BC | ドメインスコープ定義書およびコンテキストマップに定義された全BC |
| 対象処理 | 更新系ユースケース、BC間連携、外部システム連携 |
| 除外対象 | ユースケース個別設計、非機能要件詳細、テスト方針詳細 |

### 1.3 関連文書

**表2 — 関連文書一覧**
| 関連ドキュメント | 関係性 |
|----------------|--------|
| ソフトウェアアーキテクチャ方針書 | DDD・クリーンアーキテクチャの詳細を参照 |
| 非同期連携方針書 | Outbox/Saga の詳細を参照 |
| データモデリング方針書 | 永続化層の設計方針を参照 |
| 例外処理ポリシー | エラーハンドリング方針を参照 |

---

## 第2章 引用規格

本書は以下の規格・標準を参照する：

- Domain-Driven Design (Eric Evans)
- Implementing Domain-Driven Design (Vaughn Vernon)
- Microservices Patterns (Chris Richardson)

---

## 第3章 用語及び定義

**表3 — 用語定義**
| 用語 | 定義 |
|------|------|
| トランザクション境界 | ACID特性が保証される処理範囲 |
| 集約 | トランザクション整合性の単位となるエンティティ群 |
| 楽観ロック | バージョン番号等で競合を検知する方式 |
| 悲観ロック | 事前にリソースをロックする方式 |
| 結果整合性 | 最終的に整合性が保証される状態 |
| Outbox | ドメイン更新とイベント発行を同一トランザクションで行うパターン |
| Saga | 分散トランザクションを補償トランザクションで実現するパターン |

---

## 第4章 入力情報と前提

### 4.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 4.2 前提条件

* トランザクション管理は ScalarDB（DistributedTransactionManager）を前提とする：未確定
* 既存システムとの整合性制約や外部サービスの TX 対応範囲は別資料で定義される：未確定
* Outbox／Saga の利用要否は BC 横断アーキテクチャ設計に依存する：未確定
* CQRS（読み／書き分離）の適用基準は全体アーキテクチャ方針に従う：未確定
* アプリケーションサービスがトランザクション境界を持つという前提は維持：未確定
* Read-Your-Writes の要否はユースケース定義書に従い最終確定：未確定

---

## 第5章 トランザクション設計の基本方針

### 5.1 基本原則

**表4 — トランザクション基本原則**
| 原則 | 説明 |
|-----|------|
| ユースケース境界 | トランザクション境界はユースケース層（アプリケーションサービス）で定義しなければならない |
| 集約整合性優先 | 集約整合性維持を最優先とし、複数集約更新は極力回避しなければならない |
| BC内完結 | 書き込みは単一BC内で完結させることを原則としなければならない |
| 非同期連携 | 必要な場合は Outbox による非同期連携または Saga で整合性を担保しなければならない |
| 外部サービス分離 | 外部サービス呼び出しはトランザクション外部（非同期化または補償）としなければならない |

---

## 第6章 ユースケース層におけるトランザクション境界

### 6.1 境界定義

**表5 — トランザクション境界定義**
| 項目 | 方針 |
|-----|------|
| 原則 | 各ユースケースは 1 トランザクションを原則としなければならない |
| スコープ | 集約ごとの不変条件が成立する最小単位をスコープとしなければならない |
| BC横断 | 更新対象が複数BCの場合は Saga（非同期連携方針書参照）を採用しなければならない |

### 6.2 Repository の扱い

**表6 — Repository方針**
| 項目 | 方針 |
|-----|------|
| 操作範囲 | Repository 操作はユースケース層のトランザクション境界内に限定しなければならない |
| 競合検出 | 楽観ロックにより競合を検出し、リトライ戦略を適用しなければならない |

---

## 第7章 ScalarDB を用いたトランザクション制御方針

### 7.1 ACID トランザクション

**表7 — ACID TX方針**
| 項目 | 方針 |
|-----|------|
| トランザクションマネージャ | DistributedTransactionManager を必須としなければならない |
| 操作 | 全書き込み操作を ACID 保証下で実行しなければならない |
| 対象操作 | Get／Put／Delete／Scan はトランザクション内で行わなければならない |

### 7.2 楽観ロック

**表8 — 楽観ロック方針**
| 項目 | 方針 |
|-----|------|
| 検知方法 | version／updated_at を用いて競合を検知しなければならない |
| 衝突時 | ユースケースごとに定義したリトライ上限を適用しなければならない |

### 7.3 Outbox

**表9 — Outbox方針**
| 項目 | 方針 |
|-----|------|
| 書き込み | Outbox レコードは同一トランザクション内の書き込み対象としなければならない |
| 失敗時 | Outbox の永続化失敗は該当更新処理全体をロールバックしなければならない |

---

## 第8章 ユースケース群に共通するトランザクション設計ガイド

**表10 — ユースケース別トランザクションガイド**
| ユースケース種別 | 方針 |
|----------------|------|
| 更新系 | 「集約単位で完結」「外部連携はOutbox」の原則を適用しなければならない |
| 参照系 | トランザクション不要（非ACID・別DB可）としてもよい |
| Read-Your-Writes必要時 | 読みモデルを同期更新または書き込みDBを直接参照しなければならない |

---

## 第9章 CQRS／読みモデル更新のトランザクション方針

### 9.1 同一トランザクション内で読みモデルを更新する基準

**表11 — 同期更新基準**
| 条件 | 説明 |
|-----|------|
| 即時整合性必須 | クレジットカード与信／決済系など即時整合性が必須の場合 |
| 即時画面反映必須 | ユースケース直後の画面反映が必須の場合 |
| ACID整合性前提 | 参照モデルが ACID 整合性前提で設計されている場合 |

### 9.2 非同期更新（Outbox 経由）の基準

**表12 — 非同期更新基準**
| 条件 | 説明 |
|-----|------|
| 最終整合性許容 | 顧客画面に即時反映不要な場合 |
| 負荷分散必要 | 書き込み負荷分散が必要な場合 |
| レポート用途 | レポート／履歴／集計用途の読みモデルの場合 |

### 9.3 即時反映要件（クレカ系対応）

オーソリ処理、与信枠更新、利用明細登録などは\
同期読みモデル更新 or 書き込みDB参照 を必須としなければならない。

### 9.4 読みモデルDB選択方針

**表13 — 読みモデルDB選択方針**
| 観点 | Aurora for MySQL | DynamoDB |
|----|------------------|----------|
| 整合性 | 強整合性が必要な場合に選択 | 最終整合性許容の場合に選択 |
| クエリ | 複雑検索・結合が多い場合に選択 | PK/SortKey 検索中心の場合に選択 |
| 即時反映 | 必須要件に強い | 非同期モデルに適合 |

### 9.5 履歴系DBの選択方針

**表14 — 履歴系DB選択方針**
| 条件 | 選択 |
|-----|------|
| 検索条件が多様／範囲検索あり | RDB（Aurora）を選択することが望ましい |
| 高スループット・単一PKアクセス | NoSQL（DynamoDB）を選択することが望ましい |

---

## 第10章 Outbox パターンとメッセージング

**表15 — Outbox方針**
| 項目 | 方針 |
|-----|------|
| 書き込み | Outbox への書き込みは更新系トランザクション内に含めなければならない |
| 配信 | 配信はイベントブローカーで非同期に行う（詳細は非同期連携方針書参照） |
| 冪等性 | 冪等性確保はイベントIDまたは集約版数で管理しなければならない |

---

## 第11章 BC間連携／Saga のトランザクション方針

**表16 — BC間連携方針**
| 項目 | 方針 |
|-----|------|
| 単一TX禁止 | BC間更新は単一TXに含めてはならない |
| Saga開始 | Saga（オーケストレーション／コレオグラフィ）は Outbox イベントを契機として開始しなければならない |
| 補償処理 | 補償処理は BC ごとに定義しなければならない |

---

## 第12章 エラーハンドリングとリカバリ方針

**表17 — エラーハンドリング方針**
| 状況 | 方針 |
|-----|------|
| トランザクション失敗 | 全処理をロールバックし、ユーザーへは統一エラーコードで返却しなければならない |
| 楽観ロック競合 | 再試行を基本としなければならない |
| Outbox再送 | 制御は非同期連携方針書で定義する |

---

## Stop（入力不足に対する質問）

（入力情報が不足している場合、ここに質問を記載する）

---

## 論点（検討が必要な事項）

（検討が必要な論点がある場合、ここに記載する）
