あなたはセキュリティアーキテクト兼DDDを理解したシステムアーキテクトです。\
以下の【形式】に基づいて、対象システムの「トランザクション方針書」を作成してください。\
出力はすべてMarkdown形式で記載してください（JSON形式・CSV形式は禁止）。\
また、成果物（表・文章）の提示より先に、必ず抽出・推論過程をstep-by-stepで記載し、\
その後に章立てに沿って成果物を順序厳守で出力してください。\
推測による情報補完は禁止し、不明点は必ず「未確定」と明記してください。

---

**【形式】**\
`第〇章：##`\
`〇.〇：###`\
`小見出し：####`\
その他：通常テキスト\
表はMarkdown表形式で記載\
JSON / CSV形式は禁止

---

# トランザクション方針書

## 第1章：本書の位置づけ

本書は、プロジェクト全体におけるトランザクション設計の統一基準を定義し、\
アプリケーションアーキテクチャ（クリーンアーキテクチャ × DDD × CQRS × ScalarDB）に基づく実装時のガードレールとして機能する。\
ユースケース個別設計ではなく、プロジェクト全体のアーキテクチャ横断方針を対象とする。\
非機能要件およびテスト方針の詳細は本書では扱わず、別資料を参照する。

---

## 第2章 入力情報と前提

### 2.1 入力アセット

以下の正式インプットを前提とする（添付資料に基づく）：

### 2.2 前提条件

* トランザクション管理は ScalarDB（DistributedTransactionManager）を前提とする：未確定
* 既存システムとの整合性制約や外部サービスの TX 対応範囲は別資料で定義される：未確定
* Outbox／Saga の利用要否は BC 横断アーキテクチャ設計に依存する：未確定
* CQRS（読み／書き分離）の適用基準は全体アーキテクチャ方針に従う：未確定
* アプリケーションサービスがトランザクション境界を持つという前提は維持：未確定
* Read-Your-Writes の要否はユースケース定義書に従い最終確定：未確定

---

## 第3章：トランザクション設計の基本方針

トランザクション境界はユースケース層（アプリケーションサービス）で定義する。\
集約整合性維持を最優先とし、複数集約更新は極力回避する。\
必要な場合は Outbox による非同期連携または Saga で整合性を担保する。\
書き込みは単一BC内で完結させることを原則とする。\
外部サービス呼び出しはトランザクション外部（非同期化または補償）とする。

---

## 第4章：ユースケース層におけるトランザクション境界（共通方針）

### 4.1 境界定義

各ユースケースは 1 トランザクションを原則とする。\
集約ごとの不変条件が成立する最小単位をスコープとする。\
更新対象が複数BCの場合は Saga（別資料：非同期連携方針）を参照。

### 4.2 Repository の扱い

Repository 操作はユースケース層のトランザクション境界内に限定する。\
楽観ロックにより競合を検出し、リトライ戦略を適用する。

---

## 第5章：ScalarDB を用いたトランザクション制御方針

### 5.1 ACID TX

DistributedTransactionManager を必須とし、全書き込み操作を ACID 保証下で実行する。\
Get／Put／Delete／Scan はトランザクション内で行う。

### 5.2 楽観ロック

version／updated_at を用いて競合を検知する。\
衝突時はユースケースごとに定義したリトライ上限を適用する。

### 5.3 Outbox

Outbox レコードは同一トランザクション内の書き込み対象とする。\
Outbox の永続化失敗は該当更新処理全体をロールバックする。

---

## 第6章：ユースケース群に共通するトランザクション設計ガイド

更新系ユースケースは「集約単位で完結」「外部連携はOutbox」の原則を適用する。\
参照系ユースケースではトランザクション不要（非ACID・別DB可）。\
Read-Your-Writes 必要時は読みモデルを同期更新または書き込みDBを直接参照する。

---

## 第7章：CQRS／読みモデル更新のトランザクション方針

### 7.1 同一トランザクション内で読みモデルを更新する基準

即時整合性が必須（例：クレジットカード与信／決済系）。\
ユースケース直後の画面反映が必須。\
参照モデルが ACID 整合性前提で設計されている場合。

### 7.2 非同期更新（Outbox 経由）の基準

最終整合性許容（顧客画面に即時反映不要）。\
書き込み負荷分散が必要な場合。\
レポート／履歴／集計用途の読みモデル。

### 7.3 即時反映要件（クレカ系対応）

オーソリ処理、与信枠更新、利用明細登録などは\
同期読みモデル更新 or 書き込みDB参照 を必須とする。

### 7.4 読みモデルDB選択方針（Aurora for MySQL vs DynamoDB）
| 観点 | Aurora for MySQL | DynamoDB |
|----|------------------|----------|
| 整合性 | 強整合性が必要 | 最終整合性許容 |
| クエリ | 複雑検索・結合が多い | PK/SortKey 検索中心 |
| 即時反映 | 必須要件に強い | 非同期モデルに適合 |

### 7.5 履歴系DBの選択方針

検索条件が多様／範囲検索あり → RDB（Aurora）\
高スループット・単一PKアクセス → NoSQL（DynamoDB）

---

## 第8章：Outbox パターンとメッセージング

Outbox への書き込みは更新系トランザクション内に含める。\
配信はイベントブローカーで非同期に行う（詳細は非同期連携方針書を参照）。\
冪等性確保はイベントIDまたは集約版数で管理する。

---

## 第9章：BC間連携／Saga のトランザクション方針

BC間更新は単一TXに含めない。\
Saga（オーケストレーション／コレオグラフィ）は Outbox イベントを契機として開始する。\
補償処理は BC ごとに定義する。

---

## 第10章：エラーハンドリングとリカバリ方針

トランザクション失敗時は全処理をロールバックし、ユーザーへは統一エラーコードで返却する。\
楽観ロック競合は再試行を基本とする。\
Outbox の再送制御は別資料（非同期連携方針書）で定義する。