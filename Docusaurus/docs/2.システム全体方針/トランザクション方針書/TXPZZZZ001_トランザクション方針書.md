---
id: TXPZZZZ001
title: トランザクション方針書
sidebar_position: 1
---

# トランザクション方針書

| 項目 | 内容 |
|------|------|
| ドキュメントID | TXPZZZZ001 |
| 版数 | 1.0 |
| 作成日 | 2026-01-14 |
| 最終更新日 | 2026-01-14 |
| ステータス | ドラフト |

---

## 第1章 適用範囲

### 1.1 目的

本書は、ハウスクレジット基幹システム全体におけるトランザクション設計の統一基準を定義し、アプリケーションアーキテクチャ（クリーンアーキテクチャ × DDD × CQRS）に基づく実装時のガードレールとして機能する。

ユースケース個別設計ではなく、プロジェクト全体のアーキテクチャ横断方針を対象とする。

非機能要件およびテスト方針の詳細は本書では扱わず、別資料を参照しなければならない。

### 1.2 適用範囲

**表1 — 適用範囲**

| 項目 | 記述内容 |
|------|----------|
| 対象システム | ハウスクレジット基幹システム |
| 対象BC | ドメインスコープ定義書およびコンテキストマップに定義された全BC |
| 対象処理 | 更新系ユースケース、BC間連携、外部システム連携 |
| 除外対象 | ユースケース個別設計、非機能要件詳細、テスト方針詳細 |

### 1.3 関連文書

**表2 — 関連文書一覧**

| 関連ドキュメント | 関係性 |
|------------------|--------|
| ソフトウェアアーキテクチャ方針書 | DDD・クリーンアーキテクチャの詳細を参照 |
| 非同期連携方針書 | Outbox/Sagaの詳細を参照 |
| データモデリング方針書 | 永続化層の設計方針を参照 |
| 例外処理ポリシー | エラーハンドリング方針を参照 |

---

## 第2章 引用規格

本書は以下の規格・標準を参照する：

- Domain-Driven Design (Eric Evans)
- Implementing Domain-Driven Design (Vaughn Vernon)
- Microservices Patterns (Chris Richardson)
- ISO/IEC 10746 RM-ODP

---

## 第3章 用語及び定義

**表3 — 用語定義**

| 用語 | 定義 |
|------|------|
| トランザクション境界 | ACID特性が保証される処理範囲 |
| 集約 | トランザクション整合性の単位となるエンティティ群 |
| 楽観ロック | バージョン番号等で競合を検知する方式 |
| 悲観ロック | 事前にリソースをロックする方式 |
| 結果整合性 | 最終的に整合性が保証される状態（Eventual Consistency） |
| Outbox | ドメイン更新とイベント発行を同一トランザクションで行うパターン |
| Saga | 分散トランザクションを補償トランザクションで実現するパターン |
| ACID | Atomicity, Consistency, Isolation, Durabilityの頭文字 |
| 補償トランザクション | 既に完了したトランザクションの効果を打ち消すトランザクション |

---

## 第4章 トランザクション設計の基本方針

### 4.1 基本原則

本システムにおけるトランザクション設計の基本原則を以下に定める。

**表4 — トランザクション基本原則**

| 原則 | 説明 |
|------|------|
| ユースケース境界 | トランザクション境界はユースケース層（アプリケーションサービス）で定義しなければならない |
| 集約整合性優先 | 集約整合性維持を最優先とし、複数集約更新は極力回避しなければならない |
| BC内完結 | 書き込みは単一BC内で完結させることを原則としなければならない |
| 非同期連携 | BC間連携が必要な場合はOutboxによる非同期連携またはSagaで整合性を担保しなければならない |
| 外部サービス分離 | 外部サービス呼び出しはトランザクション外部（非同期化または補償）としなければならない |

### 4.2 トランザクション整合性モデル

**表5 — 整合性モデル**

| 整合性モデル | 適用範囲 | 実現方法 |
|------------|---------|---------|
| ACID整合性 | 集約内、単一BC内 | データベーストランザクション |
| 結果整合性 | 集約間、BC間 | Outbox、Saga、イベント駆動 |
| 補償による整合性 | BC横断、外部システム連携 | Saga、補償トランザクション |

---

## 第5章 ユースケース層におけるトランザクション境界

### 5.1 境界定義

ユースケース層におけるトランザクション境界の定義方針を以下に示す。

**表6 — トランザクション境界定義**

| 項目 | 方針 |
|------|------|
| 原則 | 各ユースケースは1トランザクションを原則としなければならない |
| スコープ | 集約ごとの不変条件が成立する最小単位をスコープとしなければならない |
| BC横断 | 更新対象が複数BCの場合はSaga（非同期連携方針書参照）を採用しなければならない |
| ネスト禁止 | トランザクションのネストは行ってはならない |
| 明示的制御 | トランザクション境界は明示的に定義しなければならない |

### 5.2 Repositoryの扱い

**表7 — Repository方針**

| 項目 | 方針 |
|------|------|
| 操作範囲 | Repository操作はユースケース層のトランザクション境界内に限定しなければならない |
| 競合検出 | 楽観ロックにより競合を検出し、リトライ戦略を適用しなければならない |
| 読み取り | 読み取り専用の参照はトランザクション外でも可としてもよい |
| 一貫性 | 単一ユースケース内で複数Repositoryを使用する場合も同一トランザクション内で実行しなければならない |

### 5.3 トランザクション開始・終了

**表8 — トランザクション開始・終了方針**

| タイミング | 方針 |
|-----------|------|
| 開始 | ユースケース実行開始時にトランザクションを開始しなければならない |
| コミット | ユースケース処理が正常終了した場合、トランザクションをコミットしなければならない |
| ロールバック | 例外発生時は即座にトランザクションをロールバックしなければならない |
| タイムアウト | トランザクションタイムアウトを設定しなければならない（具体値は未確定） |

---

## 第6章 集約とトランザクション

### 6.1 集約単位のトランザクション

**表9 — 集約単位トランザクション方針**

| 原則 | 説明 |
|------|------|
| 単一集約原則 | 1トランザクションでは1集約のみを変更することが望ましい |
| 集約ルート経由 | 集約の変更は必ず集約ルートを通じて行わなければならない |
| 不変条件保護 | トランザクション終了時に集約の不変条件が満たされていなければならない |
| 整合性境界 | 集約はトランザクション整合性の境界であり、集約外への直接参照を持ってはならない |

### 6.2 複数集約の更新

やむを得ず複数集約を更新する必要がある場合の方針を以下に示す。

**表10 — 複数集約更新方針**

| 条件 | 方針 |
|------|------|
| 同一BC内 | 同一トランザクション内で更新してもよいが、結果整合性での実現を検討しなければならない |
| 異なるBC | Sagaパターンまたはイベント駆動で結果整合性を実現しなければならない |
| 順序制御 | 複数集約更新時はデッドロックを避けるため、更新順序を統一しなければならない |
| 補償処理 | 一部の集約更新が失敗した場合の補償処理を定義しなければならない |

---

## 第7章 楽観ロックと競合制御

### 7.1 楽観ロック戦略

**表11 — 楽観ロック方針**

| 項目 | 方針 |
|------|------|
| 採用方式 | バージョン番号（version）または更新日時（updated_at）を用いて競合を検知しなければならない |
| 検知タイミング | 更新時に現在のバージョンと保存時のバージョンを比較しなければならない |
| 衝突時 | 楽観ロック衝突時はユースケースごとに定義したリトライ上限を適用しなければならない |
| リトライ戦略 | 指数バックオフによるリトライを実装することが望ましい |

### 7.2 悲観ロックの使用制限

**表12 — 悲観ロック使用制限**

| 項目 | 方針 |
|------|------|
| 原則 | 悲観ロックは原則として使用しないことが望ましい |
| 例外 | 高頻度更新かつ競合率が高い場合に限り、悲観ロックを検討してもよい |
| デッドロック対策 | 悲観ロック使用時はデッドロック対策（タイムアウト、順序統一）を実施しなければならない |

---

## 第8章 CQRS／読みモデル更新のトランザクション方針

### 8.1 同一トランザクション内で読みモデルを更新する基準

**表13 — 同期更新基準**

| 条件 | 説明 | 例 |
|------|------|-----|
| 即時整合性必須 | ACID整合性が業務要件として必須の場合 | クレジットカード与信、決済処理 |
| 即時画面反映必須 | ユースケース直後の画面反映が必須の場合 | 申込完了後の即時確認画面 |
| Read-Your-Writes必須 | 自分が書き込んだデータを即座に読み取る必要がある場合 | 登録直後の詳細画面表示 |

### 8.2 非同期更新（Outbox経由）の基準

**表14 — 非同期更新基準**

| 条件 | 説明 | 例 |
|------|------|-----|
| 最終整合性許容 | 数秒〜数分の遅延が許容される場合 | 管理者向けダッシュボード、レポート |
| 負荷分散必要 | 書き込み負荷を分散する必要がある場合 | 大量データの集計・分析 |
| 複数ビュー更新 | 複数の読みモデルを更新する必要がある場合 | 検索用インデックス、分析用データ |

### 8.3 即時反映要件（クレジットカード系対応）

クレジットカード業務における特定の処理は即時整合性が必須となる。

**表15 — 即時反映必須処理**

| 処理 | 理由 | 実現方法 |
|------|------|---------|
| オーソリ処理 | 利用可能枠の即時確認が必要 | 同期読みモデル更新または書き込みDB直接参照 |
| 与信枠更新 | リアルタイムな与信判断が必要 | 同期読みモデル更新 |
| 利用明細登録 | カード利用後の即時確認が必要 | 同期読みモデル更新 |

### 8.4 読みモデルDB選択方針

**表16 — 読みモデルDB選択方針**

| 観点 | Aurora for MySQL | DynamoDB |
|------|------------------|----------|
| 整合性 | 強整合性が必要な場合に選択 | 最終整合性許容の場合に選択 |
| クエリ複雑度 | 複雑検索・結合が多い場合に選択 | PK/SortKey検索中心の場合に選択 |
| 即時反映 | 必須要件に適合 | 非同期モデルに適合 |
| スケーラビリティ | 中程度のスケーラビリティ | 高いスケーラビリティ |

---

## 第9章 Outboxパターンとメッセージング

### 9.1 Outboxパターンの適用

**表17 — Outbox方針**

| 項目 | 方針 |
|------|------|
| 書き込み | Outboxへの書き込みは更新系トランザクション内に含めなければならない |
| 同一トランザクション | ドメインイベントの発行とOutbox書き込みは同一トランザクションで実行しなければならない |
| 配信 | 配信はイベントブローカーで非同期に行う（詳細は非同期連携方針書参照） |
| 冪等性 | 冪等性確保はイベントIDまたは集約版数で管理しなければならない |
| 失敗時 | Outboxの永続化失敗は該当更新処理全体をロールバックしなければならない |

### 9.2 Outboxテーブル設計

**表18 — Outboxテーブル要件**

| 項目 | 要件 |
|------|------|
| イベントID | 一意なイベントIDを持たなければならない |
| 集約ID | イベント発生元の集約IDを記録しなければならない |
| イベント種別 | イベントの種類を識別できなければならない |
| ペイロード | イベントデータをJSON等で格納しなければならない |
| ステータス | 配信状態（未配信/配信済/失敗）を管理しなければならない |
| タイムスタンプ | 作成日時・更新日時を記録しなければならない |

---

## 第10章 BC間連携／Sagaのトランザクション方針

### 10.1 BC間連携の基本方針

**表19 — BC間連携方針**

| 項目 | 方針 |
|------|------|
| 単一TX禁止 | BC間更新は単一トランザクションに含めてはならない |
| Saga開始 | Saga（オーケストレーション／コレオグラフィ）はOutboxイベントを契機として開始しなければならない |
| 補償処理 | 補償処理はBCごとに定義しなければならない |
| タイムアウト | Saga全体のタイムアウトを設定しなければならない |
| 状態管理 | Sagaの状態を永続化し、障害時の復旧を可能にしなければならない |

### 10.2 Sagaパターンの選択

**表20 — Sagaパターン選択基準**

| パターン | 適用場面 | メリット | デメリット |
|---------|---------|---------|----------|
| オーケストレーション | 複雑なフロー、中央制御が必要 | フロー可視化、エラーハンドリング容易 | 中央コンポーネントが単一障害点 |
| コレオグラフィ | シンプルなフロー、分散制御 | 疎結合、スケーラビリティ | フロー追跡困難、複雑化に弱い |

### 10.3 補償トランザクション設計

**表21 — 補償トランザクション方針**

| 項目 | 方針 |
|------|------|
| 定義必須 | 各Sagaステップには補償トランザクションを定義しなければならない |
| 冪等性 | 補償トランザクションは冪等でなければならない |
| セマンティック補償 | 業務的に意味のある補償（例：キャンセル処理）を実装しなければならない |
| 完全復旧不可 | 完全な復旧が不可能な場合は、管理者介入フローを定義しなければならない |

---

## 第11章 外部システム連携のトランザクション方針

### 11.1 外部API呼び出し

**表22 — 外部API呼び出し方針**

| 項目 | 方針 |
|------|------|
| トランザクション分離 | 外部API呼び出しはトランザクション境界外で実行することが望ましい |
| 非同期化 | 可能な限り非同期化し、Outbox経由で実行しなければならない |
| リトライ | リトライ可能な処理には適切なリトライ戦略を実装しなければならない |
| タイムアウト | 適切なタイムアウトを設定しなければならない |
| 補償処理 | 外部API呼び出し失敗時の補償処理を定義しなければならない |

### 11.2 外部システムへのデータ送信

**表23 — 外部システムデータ送信方針**

| 項目 | 方針 |
|------|------|
| Outbox経由 | 外部システムへのデータ送信はOutboxパターンで実現しなければならない |
| 冪等性保証 | 重複送信に対する冪等性を保証しなければならない |
| 送信記録 | 送信履歴を記録し、監査可能にしなければならない |

---

## 第12章 エラーハンドリングとリカバリ方針

### 12.1 エラーハンドリング

**表24 — エラーハンドリング方針**

| 状況 | 方針 |
|------|------|
| トランザクション失敗 | 全処理をロールバックし、ユーザーへは統一エラーコードで返却しなければならない |
| 楽観ロック競合 | 再試行を基本とし、リトライ回数上限を超えた場合はエラーとして返却しなければならない |
| データベース障害 | 適切なエラーメッセージをログに記録し、ユーザーにはシステムエラーを返却しなければならない |
| タイムアウト | タイムアウト発生時はトランザクションをロールバックしなければならない |

### 12.2 リカバリ戦略

**表25 — リカバリ戦略**

| 項目 | 方針 |
|------|------|
| Outbox再送 | Outboxの未配信メッセージは定期的に再送処理を実行しなければならない（詳細は非同期連携方針書参照） |
| Saga復旧 | Sagaの中断状態から復旧する仕組みを実装しなければならない |
| 手動介入 | 自動復旧不可能な場合は管理者による手動介入フローを定義しなければならない |
| ログ記録 | すべてのトランザクションエラーは詳細なログとして記録しなければならない |

---

## 第13章 パフォーマンス考慮事項

### 13.1 トランザクション期間の最小化

**表26 — トランザクション期間最小化方針**

| 項目 | 方針 |
|------|------|
| 処理の最小化 | トランザクション内の処理は必要最小限としなければならない |
| 外部I/O除外 | 外部I/O（API呼び出し、ファイルアクセス等）はトランザクション外で実行しなければならない |
| 複雑な計算除外 | 複雑な計算処理はトランザクション前に実施することが望ましい |
| ロック保持時間 | データベースロックの保持時間を最小化しなければならない |

### 13.2 デッドロック回避

**表27 — デッドロック回避方針**

| 項目 | 方針 |
|------|------|
| 更新順序統一 | 複数リソース更新時は更新順序を統一しなければならない |
| タイムアウト設定 | デッドロック検知のためのタイムアウトを設定しなければならない |
| リトライ戦略 | デッドロック発生時のリトライ戦略を実装しなければならない |

---

## 付録A 未確定事項一覧

本方針書において「未確定」と記載された事項を以下にまとめる。これらは後続の検討・合意形成により確定させなければならない。

**表A.1 — 未確定事項一覧**

| 章節 | 項目 | 備考 |
|------|------|------|
| 5.3 | トランザクションタイムアウトの具体値 | 非機能要件との整合が必要 |
| 12.2 | Outbox再送の具体的な戦略 | 非同期連携方針書での詳細化が必要 |
| 13.1 | トランザクション期間の具体的な目標値 | 性能要件との整合が必要 |

---

## 付録B 検討が必要な論点

以下は、本方針書の運用にあたり検討が必要な論点である。

1. **データベース技術の選定**
   - RDB（Aurora）vsNoSQL（DynamoDB）の使い分け基準の詳細化
   - 分散トランザクション機能の有無と影響
   - イベントストアの導入可否

2. **Saga実装方式の詳細**
   - オーケストレーションvsコレオグラフィの具体的な選択基準
   - Sagaオーケストレータの実装方式
   - Saga状態管理の実装

3. **パフォーマンスとトレードオフ**
   - トランザクション整合性とパフォーマンスのバランス
   - 読みモデルの同期更新と非同期更新の性能比較
   - 楽観ロックの競合率とリトライコスト

4. **監視・運用**
   - トランザクション失敗率の監視
   - Sagaの進行状況監視
   - Outbox未配信メッセージの監視とアラート

5. **テスト戦略**
   - トランザクション境界のテスト方法
   - 結果整合性のテスト方法
   - Sagaの補償トランザクションテスト

6. **移行戦略**
   - 既存システムからの段階的移行
   - データ移行時のトランザクション整合性
   - ハイブリッド運用時の考慮事項

---
